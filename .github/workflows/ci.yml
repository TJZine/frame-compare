name: CI

on:
  push:

  pull_request:


jobs:
  tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Ensure cache directory
        run: mkdir -p ~/.cache/uv
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
      - name: Install dependencies
        run: uv sync --group dev --extra preview --frozen --python 3.13 --no-install-package vapoursynth
      - name: Prime workspace config
        run: uv run --no-sync python frame_compare.py --root . --write-config
      - name: Diagnose workspace paths
        run: uv run --no-sync python frame_compare.py --root . --diagnose-paths
      - name: Run tests
        run: uv run --no-sync python -m pytest -q

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Ensure cache directory
        run: mkdir -p ~/.cache/uv
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
      - name: Install dependencies
        run: uv sync --group dev --frozen --python 3.13 --no-install-package vapoursynth
      - name: Run pyright
        run: uv run --no-sync npx pyright --warnings
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Ensure cache directory
        run: mkdir -p ~/.cache/uv
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
      - name: Install dependencies
        run: uv sync --group dev --frozen --python 3.13 --no-install-package vapoursynth
      - name: Ruff lint
        run: uv run --no-sync ruff check
      - name: Config docs generator check
        run: uv run --no-sync python tools/gen_config_docs.py --check docs/_generated/config_tables.md
      - name: Install import-linter
        run: uv pip install import-linter
      - name: Verify import contracts
        run: uv run --no-sync lint-imports --config importlinter.ini
  windows-smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - uses: actions/checkout@v4
      - name: VSPreview console smoke (cp1252)
        shell: pwsh
        run: |
          chcp 1252 | Out-Null
          $env:PYTHONIOENCODING = 'cp1252'
          $scriptPath = Join-Path $env:RUNNER_TEMP "vspreview_console_smoke.py"
          $script = @'
          import sys

          try:
              if hasattr(sys.stdout, "reconfigure"):
                  sys.stdout.reconfigure(encoding="utf-8", errors="replace")
              if hasattr(sys.stderr, "reconfigure"):
                  sys.stderr.reconfigure(encoding="utf-8", errors="replace")
          except Exception:
              pass


          def safe_print(msg: str) -> None:
              try:
                  print(msg)
              except Exception:
                  try:
                      print(msg.encode("utf-8", "replace").decode("utf-8", "replace"))
                  except Exception:
                      print("[log message unavailable due to encoding]")


          safe_print("Adjusted FPS for target 'clip' to match reference (30000/1001 -> 24000/1001)")
          safe_print("VSPreview outputs: reference on even slots, target on odd slots (0<->1, 2<->3, ...).")
          '@
          Set-Content -Path $scriptPath -Value $script -Encoding UTF8
          python $scriptPath
  packaging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Ensure cache directory
        run: mkdir -p ~/.cache/uv
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
      - name: Create venv
        run: uv venv
      - name: Install packaging tooling
        run: uv pip install build twine check-wheel-contents
      - name: Build wheel and sdist
        run: uv run --no-sync python -m build
      - name: Validate metadata with twine
        run: uv run --no-sync twine check dist/*
      - name: Validate wheel contents
        run: |
          uv run --no-sync python - <<'PY'
          import glob
          import sys
          import zipfile

          wheels = glob.glob('dist/*.whl')
          if not wheels:
              sys.exit('No wheel built.')
          with zipfile.ZipFile(wheels[0]) as z:
              names = set(z.namelist())
          required = {
              'src/frame_compare/py.typed',
              'data/config.toml.template',
              'data/report/index.html',
              'data/report/app.css',
              'data/report/app.js',
          }
          missing = sorted(name for name in required if name not in names)
          if missing:
              sys.exit(f'Missing expected files in wheel: {missing}')
          print('Wheel contents OK')
          PY
      - name: check-wheel-contents (warnings only)
        run: uv run --no-sync check-wheel-contents dist/*.whl || true
