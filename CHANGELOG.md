# Changelog

All notable user-visible updates will be documented in this file in reverse chronological order.

- *2025-11-10:* Phase 2.3 documentation/tooling hand-off: refreshed the runner-refactor trackers, reiterated the wizard compatibility surface (`frame_compare.resolve_wizard_paths` / `_resolve_wizard_paths` now forward into `src.frame_compare.wizard`), and re-ran the quality gates (`pytest -q` 209 passed / 54 skipped, `.venv/bin/ruff check`, `npx pyright --warnings` still blocked offline so `.venv/bin/pyright --warnings` recorded as the fallback).
- *2025-11-10:* Codex/AGENTS/README now explicitly require Sequential Thinking loops to log every stage with `next_thought_needed=true` until the Review entry so orchestration never stops mid-plan.
- *2025-11-19:* Phase 1.1 modularization: `src/frame_compare/preflight.py` now exposes `resolve_workspace_root`, `resolve_subdir`, `collect_path_diagnostics`, `prepare_preflight`, and `PreflightResult`, and the CLI/runner/tests were rewired to consume the shared API (legacy `_…` aliases remain for compatibility).
- *2025-11-09:* Hardened CLI tonemap overrides: all numeric flags now reject non-finite inputs, `--tm-target` enforces positive values, and regression tests cover the new validation paths.
- *2025-11-10:* Corrected future-dated DECISIONS/CHANGELOG rows and documented the requirement to stamp new log entries with `date -u` so timelines stay accurate.
- *2025-11-10:* Refined AGENTS/CODEX operational guardrails: Standard Flow now captures Context7-first citations plus in-response Fetch MCP metadata logging, and CODEX documents MCP auto-approval rules, `.venv`-first verification with `uv sync` fallbacks, an escalation playbook, and requirements for large refactor micro-plans.
- *2025-11-09:* Phase 5 runner QA: verified TMDB orchestration already flows through the shared resolver, ensured reporter injection docs/tests cover automation scenarios, and reran `npx pyright --warnings`, `.venv/bin/ruff check`, and `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (258 passed) on a networked host.
- *2025-11-09:* Updated CODEX/AGENTS guardrails to require local `.venv/bin/pyright`/Ruff/Pytest runs, allow cache directories for approved checks, and document the `uv sync --all-extras --dev` setup workflow. Packaging releases now exclude dev-only folders (tests/docs/Legacy/refactor/tools) via `MANIFEST.in` so end users download only runtime files, while `comparison_videos/` remains included for fixture availability.
- *2025-11-09:* Guardrail docs now require assistants to provide a Conventional Commit-style subject in every response so the user can copy it directly into `git commit -m …`.
- *2025-11-08:* Tightened the CLI shim surface by removing the `globals().update`/`__getattr__` re-export from `frame_compare.py`, adding an explicit compatibility map plus `typings/frame_compare/__init__.pyi`, and moving tests to import helpers from `src.frame_compare.core`/`cli_runtime` directly.
- *2025-11-08:* Enhanced the public runner API: `RunRequest` now accepts optional `console`, `reporter`, and `reporter_factory` parameters, quiet runs automatically use a new `NullCliOutputManager`, and README demonstrates how automation can silence output or inject custom reporters. Added regression tests to guard the behavior.
- *2025-11-09:* Restored `frame_compare --diagnose-paths` to run without creating or requiring a config file, updated the preflight tests to stub `src.frame_compare.preflight.load_config`, and logged the refreshed `.venv/bin/ruff check` / `.venv/bin/pytest -q` (250 passed, 1 skipped) results plus the still-blocked `npx pyright --warnings` (npm ENOTFOUND) in the Phase 4.3 quality gates.

- *2025-11-03:* Added a reusable CLI harness for runner validation (`_CliRunnerEnv` plus `_patch_core_helper`, `_patch_runner_module`, `_patch_vs_core`, `_patch_audio_alignment`), migrated the CLI-heavy tests in `tests/test_frame_compare.py` and `tests/test_paths_preflight.py` to the new fixtures, centralized VapourSynth stubs, and re-ran `.venv/bin/pytest tests/test_frame_compare.py tests/test_paths_preflight.py` along with the full `.venv/bin/pytest` suite (247 passed, 1 skipped). `npx pyright --warnings` remains blocked offline (`npm ERR! ENOTFOUND registry.npmjs.org`).
- *2025-11-08:* Documented the public runner API for automation (README “Programmatic Usage”), logged the Phase 2.3 quality gates (`.venv/bin/ruff check`, `.venv/bin/pytest`), captured the offline `npx pyright --warnings` failure for follow-up, and initialized the residual-risk log in `docs/runner_refactor_checklist.md`.
- *2025-11-10:* Split helper logic into `src/frame_compare/core.py`, removed the runner’s `_IMPL_ATTRS` indirection in favor of direct imports, re-exported helpers via `frame_compare.py`, and updated tests/docs to record Phase 4.1 completion.
- *2025-11-01:* Phase 4.2 regression parity: added runner-level slow.pics/audio-alignment tests, refreshed README + docs/DECISIONS.md to document the public API guarantees, updated `docs/runner_refactor_checklist.md`, and re-ran `npx pyright --warnings` (0 issues) to lock the helper extraction work.
- *2025-11-09:* Closed the runner refactor Phase 3 quality gates: reran `npx pyright --warnings`, `.venv/bin/ruff check`, and `.venv/bin/pytest` (246 passed), updated `docs/runner_refactor_checklist.md` with the final statuses, and documented the remaining helper-migration work as the Phase 4 kickoff task.
- *2025-11-08:* Finished the Phase 1 runner extraction: the orchestration logic now lives in `src/frame_compare/runner.py`, `frame_compare.run_cli` is a thin shim that delegates through a `RunRequest`, tests exercise the new module boundary, and documentation captures the runner API plus Phase 2 follow-ups.
- *2025-11-07:* Refreshed tone-mapping presets to align with the new advanced controls: upgraded `reference`, `filmic`, `spline`, and `contrast` profiles, added `bright_lift` and `highlight_guard`, and updated defaults (smoothing 45f, percentile `99.995`, contrast recovery `0.30`) across docs, template, and layout.
- *2025-11-06:* Added BT.2390 knee, dynamic-peak-detection presets, and optional post-tonemap gamma lift. `[color]` now exposes `dst_min_nits=0.18`, `knee_offset`, `dpd_preset`, `dpd_black_cutoff`, and `post_gamma`, libplacebo calls forward `tone_mapping_param`/`peak_detection_preset`/`black_cutoff` with compatibility shims, overlays understand `{knee_offset}`, `{dpd_preset}`, `{dst_min_nits}`, and new CLI flags (`--tm-*`) allow per-run overrides. Docs, presets, and tests updated accordingly.
- *2025-11-06:* Default screenshot exports now expand limited-range SDR to full-range RGB via a new `[screenshots].export_range` setting (default `"full"`), with `"limited"` preserving video-range PNGs. Both VapourSynth and FFmpeg writers honour the option, `_SourceColorRange` provenance is recorded when expanding, and documentation/tests/config templates were updated accordingly.
- *2025-11-05:* Harmonised HDR tonemap range metadata with sampled RGB output, wiring detected `_ColorRange` through geometry and overlays, preserving frame props during subtitle paths, and extending regression coverage/docs for the updated pipeline.
- *2025-10-30:* Auto-launched the configuration wizard during interactive first runs when `config/config.toml` is missing, added a `--no-wizard` flag plus `FRAME_COMPARE_NO_WIZARD` override, surfaced a fallback reminder for non-interactive sessions, and refreshed README/tests accordingly.
- *2025-10-30:* Replaced the audio alignment “progress” bar with a spinner so CLI output stays truthful while offsets are estimated.
- *2025-10-30:* Overhauled the offline HTML report viewer with persistent zoom/fit presets, pointer-anchored wheel zoom, pan/align controls, and shortcut legends to better mirror slow.pics.
- *2025-10-29:* Added optional HTML report generation (configurable via `[report]` or `--html-report`), including vendored assets, CLI auto-open support, JSON-tail disclosures, embedded report data for offline viewing, and unit coverage for the new generator. Added overlay mode toggle with keyboard/click encode cycling.
- *2025-10-29:* Added interactive `frame-compare wizard` with presets, introduced `frame-compare doctor` dependency checklist (JSON-capable), expanded reference docs, and strengthened CLI help/tests for the new commands.
- *2025-10-29:* Clarified the CLI audio alignment panel output (stream summaries, cached reuse messaging, offsets file footer) and aligned documentation; slow.pics shortcut filenames now derive from the sanitised collection name with regression tests for edge cases; README and reference tables updated.
- *2025-10-22:* Disabled slow.pics auto-upload by default, added an upfront CLI warning when it is enabled, aligned documentation with dataclass defaults, introduced a packaged `frame-compare` console entry point, and wired Ruff linting into CI (Pyright now blocks failures).
- *2025-10-21:* Prevented VSPreview helper crashes on Windows `cp1252` consoles by sanitising printed arrows to ASCII, preferring UTF-8 output streams, adding regression coverage, and documenting the console behaviour.
- *2025-10-20:* Hardened audio alignment's optional dependency handling by surfacing clear `AudioAlignmentError` messages when
  `numpy`, `librosa`, or `soundfile` fail during onset envelope calculation, and refreshed regression coverage for the failure
  path.
- *2025-10-20:* VSPreview-assisted manual alignment now displays existing manual trims using friendly clip labels so operators
  can immediately see which plan each baseline affects before accepting new deltas.
- *2025-10-20:* Prevented VSPreview script overwrites by appending per-run entropy to generated filenames and warning when a
  collision is detected.
- *2025-10-20:* Fixed mod-2 odd-geometry failures by pivoting subsampled SDR clips through YUV444P16 when needed, emitting Rich console notes that summarise the axis/policy, and expanding docs/config guidance for the `odd_geometry_policy` and `rgb_dither` options.
- *2025-10-19:* Normalised VapourSynth colour metadata inference for SDR clips, cached inferred props on the
  clip to avoid redundant frame grabs, exposed config overrides for HD/SD defaults and per-file colour
  corrections, refreshed documentation, and expanded regression coverage for the new heuristics.
- *2025-10-18:* Fixed VapourSynth RGB conversion when colour metadata is absent by defaulting to Rec.709
  limited parameters, preventing fpng "no path between colours" failures and adding regression coverage.
- *2025-10-17:* Documented the VSPreview-assisted manual alignment flow (README, reference tables, pipeline guide), surfaced the
  CLI help text, added a fallback regression test, and published a cross-platform QA checklist for manual verification.
- *2025-10-16:* Hardened analysis cache and audio offsets paths to stay within the workspace root, added regression tests for escape attempts, removed the generated `config.toml` from source control in favour of the packaged template, and restricted screenshot cleanup to directories created during the current run.
- *2025-10-16:* Limited supported Python versions to 3.13.x (`>=3.13,<3.14`) to align with current `librosa`/`numba` wheels; updated project metadata and lockfile.
- *2025-10-14:* Locked workspace roots to `--root`/`FRAME_COMPARE_ROOT`/sentinel discovery, seeded config under `ROOT/config/config.toml`, enforced `ROOT/comparison_videos[/screens]`, added `--diagnose-paths`, and blocked site-packages writes before screenshotting.
- *2025-10-12:* Default config now seeds to `~/.frame-compare/config.toml`, `[paths].input_dir` defaults to `~/comparison_videos`, and the packaged template ships from `src/data/` (with wheel coverage) to avoid site-packages permission issues. *(Superseded by 2025-10-14 workspace root lock.)*
- *2025-10-11:* Added an optional `$FRAME_COMPARE_TEMPLATE_PATH` override and filesystem fallback for the packaged config template plus clearer screenshot permission errors so runs targeting read-only `comparison_videos` trees fail fast with guidance.
- *2025-10-19:* Seed the packaged default config into a per-user directory when the project tree is read-only so packaged installs no longer fail to start on permission errors.
- *2025-10-20:* Allow disabling the per-frame FFmpeg timeout by setting `screenshots.ffmpeg_timeout_seconds` to 0 while keeping negative values invalid in validation and docs.
- *2025-10-18:* Added a per-frame FFmpeg timeout and disabled stdin consumption to prevent hung screenshot renders and shell freezes on Windows.
- *2025-10-17:* Streamlined CLI framing: removed the banner row, surfaced cached-metrics reuse inside the Analyze block, dropped the At-a-Glance crop-mod readout in favour of effective tonemap nits, and trimmed the Summary output frames line to match the refreshed console layout and tests.
- *2025-10-16:* Documented deep-review finding: screenshot cleanup must enforce path containment before deleting outputs; remediation planned.

- *2025-10-15:* Relocated bundled comparison fixtures to the repository-root `comparison_videos/` directory, updated CLI docs to match the default `paths.input_dir`, and noted the new resolution fallbacks.
- *2025-10-14:* Clarified CLI hierarchy by softening section badge colors, brightening subhead prefixes, expanding the At-a-Glance box with alignment, sampling, and canvas metrics for quicker triage, and realigning the Summary section with key/value formatting to remove ragged rows.
- *2025-10-13:* Removed the `types-pytest` dev dependency so `uv run` can resolve environments on fresh clones without relying on a non-existent stub package while keeping the actual `pytest` runtime dependency in the dev group for CI and local tests.
- *2025-10-10:* Reject invalid `cli.progress.style` values during configuration loading and persist normalized styles for downstream flag handling to keep CLI reporters consistent.
- *2025-10-12:* Added local type stubs for optional CLI/testing dependencies and hardened JSON-tail assertions in tests so Pyright runs cleanly without relaxing diagnostic settings.
- *2025-10-09:* Expanded minimal overlays with resolution/upscale and frame-selection type lines while simplifying diagnostic overlays by removing on-screen selection timecode/score/notes that remain available via cached metadata.
- *2025-10-02:* Scoped audio alignment's NumPy flush-to-zero warning suppression to local contexts, added regression tests to keep diagnostics available, and hardened TMDB caching with TTL-aware eviction to cap memory growth during long CLI sessions.
- *2025-10-01:* Added selection metadata persistence v1: cached JSON sidecar, compframes annotations, CLI summary metrics, and screenshot overlay reuse without rerunning analysis.
- *2025-10-01:* Added `docs/audio_alignment_pipeline.md` to detail the alignment workflow, configuration constraints, and offsets file contract.
- *2025-09-30:* Enhanced CLI group blocks with accent subhead glyphs, dimmed divider rules, numeric alignment, and verbose legends describing token colouring for RENDER/PREPARE sections.
- *2025-09-30:* Diagnostic overlay now replaces the HDR MAX/AVG measurement block with render resolution details, mastering display luminance (if present), and cached frame-selection metadata while trimming redundant frame-info lines for leaner CLI banners.
- *2025-09-29:* Initialize changelog to align with repository persistence rules.
- *2025-09-29:* Revamped CLI presentation: extended palette, added style spans, highlights, section accents, progress bar styling, verification metrics, and refreshed templates per `features/CLI/GUIDE.md`.
- *2025-11-10:* Ensured runner funnels audio alignment through `core._maybe_apply_audio_alignment` again (restoring the test/mocking seam) and deep-copied the JSON-tail audio block before building CLI layout views so manual trims, VSPreview offsets, and reference trims persist. Added regression coverage, reran the full suite, and cleaned up Ruff/Pyright diagnostics that surfaced after the refactor.
