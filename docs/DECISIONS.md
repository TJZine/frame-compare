# Decisions Log

- *2025-11-10:* Strengthened AGENTS/CODEX guardrails for MCP tooling: Standard Flow now mandates Context7-first citations and detailed Fetch MCP metadata logging (URL, timestamp, format, chunking) directly in responses, plus TaskFlow + snf-mcp recommendations for structured planning/search (no repo-level evidence storage yet per user request). CODEX now lists MCP usage in Execution & Approvals, adds an escalation playbook, clarifies `.venv`-first verification with `uv sync` fallbacks, and records how large refactors can proceed once a micro-plan + verification schedule are approved.
- *2025-11-10:* Corrected future-dated DECISIONS/CHANGELOG entries by aligning them with actual UTC (`date -u`) stamps and updated AGENTS/CODEX so every log requires capturing the current date before writing.
- *2025-11-08:* Started the configuration-audit initiative requested by the user: created `docs/config_audit.md` to track per-category findings/status, recorded the workflow expectations (Context7 reference, ripgrep sweeps, approval gates), and deferred all actual config/code updates until the user signs off category-by-category.
- *2025-11-08:* Landed the `[analysis]` configuration cleanup: removed the redundant `skip_head_seconds`/`skip_tail_seconds` knobs (loader now migrates them onto `ignore_*` with conflict checks), introduced `[analysis.thresholds]` with an explicit `mode = "quantile" | "fixed_range"` plus validated quantile/luma payloads, and updated the runner/JSON layouts so operators can see the active strategy.
- *2025-11-08:* Addressed the Phase 4 “thin shim” code review item: removed the blanket `globals().update`/`__getattr__` bridge from `frame_compare.py`, explicitly aliased the handful of helpers we still expose for backwards compatibility, and added a `typings/frame_compare/__init__.pyi` stub so Pyright flags any future wildcard re-exports. Updated the CLI/runner tests (`tests/test_frame_compare.py`, `tests/test_console_safety.py`, `tests/test_paths_preflight.py`, `tests/test_cli_doctor.py`) to import helpers from `src.frame_compare.core`/`cli_runtime` directly, keeping the shim focused on Click wiring.
- *2025-11-08:* Delivered the promised programmatic runner API knobs: `RunRequest` now accepts `reporter_factory`/`reporter`/`console`, `quiet=True` swaps in a `NullCliOutputManager` so automation logs remain silent, and README documents how to inject a custom reporter. Added regression tests ensuring quiet mode bypasses the CLI renderer and that custom factories are respected.

- *2025-11-09:* Phase 5 completion: confirmed TMDB orchestration already flows through `core.resolve_tmdb_workflow`, verified reporter injection docs/tests cover automation use, and reran quality gates on a connected host — `npx pyright --warnings`, `.venv/bin/ruff check`, and `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (258 passed in 7.21 s) to bypass the auto-loaded vsengine plugin. Recorded results here and flipped the Phase 5 checklist rows to ☑.

- *2025-11-09:* Phase 1.1 prep for the modularization refactor: captured `git status -sb`, ran `pytest -q` (204 passed, 54 skipped, 4.90 s), `.venv/bin/ruff check` (pass), and `npx pyright --warnings` (0 errors). These baseline numbers log the required Phase 0 checklist before extracting the dedicated preflight module.
- *2025-11-09:* Phase 1.1 implementation: promoted the preflight helpers to a public API (`resolve_workspace_root`, `resolve_subdir`, `collect_path_diagnostics`, `prepare_preflight`, `PreflightResult`), rewired the CLI/runner/tests/typings, and updated the refactor tracker + checklist. Verification: `pytest -q` (204 passed, 54 skipped, 4.66 s), `.venv/bin/ruff check` (pass), `npx pyright --warnings` (0 issues).
- *2025-11-09:* Hardened tonemap override validation to reject NaN/Inf inputs and enforce positive `target_nits`, expanding the CLI regression tests accordingly. Verification: `.venv/bin/ruff check` (pass), `npx pyright --warnings` (blocked offline, npm ENOTFOUND registry.npmjs.org), `uv run pyright --warnings` (blocked by sandbox permissions when opening `~/.cache/uv`), and `.venv/bin/pytest -q` (253 passed, 1 skipped).
- *2025-11-09:* Updated CODEX/AGENTS guardrails to prioritize `.venv/bin/pyright`/Ruff/Pytest, explicitly allow `.venv`/`.uv_cache`/`~/.cache/uv` access, and document the `uv sync --all-extras --dev` setup workflow so future runs don’t depend on npm/network access.
- *2025-11-09:* Added `MANIFEST.in` to prune dev-only folders (`tests/`, `docs/`, `Legacy/`, `refactor/`, `tools/`, `.github/`) from release artifacts so end users install only runtime code; `comparison_videos/` is still shipped so fixture media remains available.
- *2025-11-09:* Updated CODEX/AGENTS documentation to require assistants to provide a ready-to-copy Conventional Commit subject (e.g., `chore: …`) in every task summary so users with commit hooks can paste it directly.

- *2025-11-09:* Phase 2.2 CLI shim follow-up: restored `_collect_path_diagnostics` to run with `ensure_config=False` so `frame_compare --diagnose-paths` no longer creates config files, taught `_patch_load_config` in `tests/test_paths_preflight.py` to stub `src.frame_compare.preflight.load_config`, and re-ran `.venv/bin/ruff check` (pass), `npx pyright --warnings` (still blocked offline with `npm ENOTFOUND registry.npmjs.org`), and `.venv/bin/pytest -q` (250 passed, 1 skipped) to close the Phase 4.3 quality gates.

- *2025-11-02:* Phase 4.2 verification follow-up: fixed the CLI shim imports so Pyright can see `_core` helpers, reran `npx pyright --warnings` (0 errors, 9 benign pytest warnings), restored `src/frame_compare/core.py`’s `PROJECT_ROOT` to the repo root so presets/templates resolve, and re-ran `pytest tests/test_cli_doctor.py tests/test_cli_wizard.py` to confirm wizard auto-launch + preset flows still pass before moving to Phase 4.3.
- *2025-11-07:* Phase 4.3 QA: captured `git status -sb` before sign-off, attempted `npx pyright --warnings` (fails offline with `npm ENOTFOUND registry.npmjs.org`), and ran `.venv/bin/ruff check` plus `.venv/bin/pytest` (247 passed, 1 skipped). Recorded the blocked Pyright step, refreshed the runner checklist, and documented Phase 5 follow-ups (runner reporter injection + async TMDB parity).
- *2025-11-03:* Completed the CLI harness rollout for runner-focused tests: introduced a `_CliRunnerEnv` fixture that stubs `_prepare_preflight` and seeds temporary workspaces, added shared helpers (`_patch_core_helper`, `_patch_runner_module`, `_patch_vs_core`, `_patch_audio_alignment`) so tests patch the same symbols the runner imports, migrated `tests/test_frame_compare.py` and `tests/test_paths_preflight.py` to the new fixtures, and reran `.venv/bin/pytest tests/test_frame_compare.py tests/test_paths_preflight.py` followed by the full `.venv/bin/pytest` suite (247 passed, 1 skipped). `npx pyright --warnings` still fails offline (npm ENOTFOUND); noted for follow-up once network access is available.
- *2025-11-10:* Phase 4.1 helper extraction: created `src/frame_compare/core.py`, rewired `runner.py` to import helpers directly (removing `_IMPL_ATTRS`), re-exported the helpers via `frame_compare.py`, refreshed tests, and documented the completion in `docs/runner_refactor_checklist.md`.
- *2025-11-01:* Phase 4.2 regression parity + documentation: reviewed wizard/doctor coverage, exercised the new runner-level regression tests (slow.pics auto-upload cleanup + audio-alignment reuse), recorded the verification in `docs/runner_refactor_checklist.md`, updated README/CHANGELOG, and re-ran `npx pyright --warnings` (0 issues) to lock in the helper extraction work.
- *2025-11-09:* Phase 3.2 quality gates + handoff: ran `npx pyright --warnings` (0 issues), `.venv/bin/ruff check`, and `.venv/bin/pytest` (246 passed in 2.36 s); updated `docs/runner_refactor_checklist.md` to mark the phase complete and documented the Phase 4 kickoff task (migrating `_IMPL_ATTRS` helpers) as the sole residual risk.
- *2025-11-08:* Phase 2.3 (runner refactor) documentation + quality gates: README now includes a "Programmatic Usage" section that demonstrates `frame_compare.runner.RunRequest`, `docs/runner_refactor_checklist.md` records the Phase 2 audit plus a residual-risk log, and `CHANGELOG.md` highlights the public API guidance. `.venv/bin/ruff check` and `.venv/bin/pytest` passed (246 tests in 2.42s). `npx pyright --warnings` could not run due to offline npm access, so rerunning Pyright remains a follow-up together with the remaining CLI-helper migration.
- *2025-11-09:* Phase 3.1 checklist review complete: verified workspace state (`git status -sb`), confirmed shim + behavior coverage (see `frame_compare.py:4415-4444`, `tests/test_frame_compare.py:52-138`), reran `npx pyright --warnings` (0 issues) and `.venv/bin/pytest` (246 passed in 2.42 s), and updated `docs/runner_refactor_checklist.md` to reflect the remaining architecture/dead-code gap caused by `_IMPL_ATTRS` relying on CLI helpers.
- *2025-11-08:* Restored the runner extraction after the rollback: `src/frame_compare/runner.py` now owns the full orchestration flow, `frame_compare.run_cli` is a shim that builds a `RunRequest` and delegates, and the Click stack (doctor/wizard/preset) stays in `frame_compare.py`. Tests that poked internal helpers now import them from the runner when needed, and the new module is documented as the supported programmatic surface. **Phase 2 hand-off:** Objective → publish a stable public runner API (docs + samples) and remove lingering CLI-only helpers from tests; Follow-ups → document programmatic invocation in README, add integration tests that call `runner.run` directly, explore packaging a `frame_compare.runner` console entry for automation; Risks → callers may rely on internal helpers before the API stabilises, so changes must remain backwards-compatible until the contract is formalised.
- *2025-11-07:* Split the CLI orchestration into `src/frame_compare/runner.py`, moving `RunResult` plus the full `run` logic behind a `RunRequest` struct. `frame_compare.py` now acts as a thin Click wrapper delegating to the runner while re-exporting compatibility symbols, keeping wizard/doctor wiring untouched.
- *2025-11-07:* Retuned tone-mapping presets to use the new libplacebo controls: upgraded `reference`/`filmic`/`spline`/`contrast`, added `bright_lift` and `highlight_guard`, nudged defaults (smoothing 45f, percentile `99.995`, contrast `0.30`), and propagated the changes through docs, config templates, and layout summaries.
- *2025-11-06:* Exposed libplacebo smoothing/scene thresholds, percentile, contrast recovery, metadata selection, Dolby Vision toggles, and tonemap debugging flags (`visualize_lut`, `show_clipping`). Config schema, CLI, layout, and docs were updated so operators can replicate libplacebo’s `high_quality` profile or audit tone-mapping output without editing scripts; compatibility shims still cover older plugins.
- *2025-11-06:* Added BT.2390 knee/DPD controls and the limited-range post-tonemap gamma stage. Config schema now exposes `knee_offset`, `dst_min_nits=0.18` defaults, `dpd_preset`, `dpd_black_cutoff`, and optional gamma lift toggles, alongside CLI overrides (`--tm-*`) and updated presets/docs/tests to prevent near-black crush regressions.
- *2025-11-06:* Added `[screenshots].export_range` (default `"full"`) to control final PNG range, expanding limited SDR to sRGB by default while retaining a `"limited"` escape hatch; updated screenshot writers, config templates, docs, and tests to reflect the change.
- *2025-11-05:* Sampled tonemapped RGB clips to detect actual colour range, aligning `_ColorRange` metadata with pixel values, preserving props across overlays, and documenting/testing the harmonised path to prevent washed-out PNGs.
- *2025-10-31:* Enhanced the offline HTML report viewer with filmstrip thumbnails, selection-category filters, new difference/blink modes, and a fullscreen toggle. Updated styles, keyboard shortcuts, and documentation to reflect the richer theatre experience while keeping persistence compatible with previous localStorage payloads.
- *2025-10-30:* Auto-launched the wizard when `config/config.toml` is missing in interactive sessions, added `--no-wizard`/`FRAME_COMPARE_NO_WIZARD` opt-outs, reused the existing wizard prompt stack for config creation, and left non-interactive runs seeding the template with a reminder about `frame-compare wizard`.
- *2025-10-30:* Revamped the offline HTML report viewer with persistent zoom/fit presets, mouse-wheel zoom around the pointer, pan gestures, alignment presets, and shortcut guidance to align the offline experience with slow.pics.
- *2025-10-30:* Audio alignment progress now uses a Rich spinner instead of a misleading 0/1 progress bar to keep CLI feedback honest during offset estimation.
- *2025-10-22:* Default slow.pics uploads now ship disabled (`auto_upload=false`) with a CLI warning when operators opt in, documentation tables are generated from dataclass defaults, Ruff linting was added to CI (Pyright made blocking), a `frame-compare` console script was registered, and the unused `tools/readability_check.py` helper was retired.
- *2025-10-23:* Introduced the offline HTML report (configurable via `[report]` or `--html-report`) backed by `src/report.py`, vendored assets (`src/data/report/`), and CLI integration that auto-opens the generated `index.html` when requested. Added unit coverage (`tests/test_report.py`) and documented the workflow in README/config references.
- *2025-10-24:* Enhanced the HTML report viewer with a mode toggle (`slider` vs `overlay`), added keyboard/click encode cycling, embedded report data to avoid `file://` fetch issues, and expanded JS/CSS to support both viewing experiences.
- *2025-10-20:* Guaranteed VSPreview script uniqueness by adding per-run UUID suffixes and logging when a timestamped name is already present so operators keep manual edits across concurrent sessions.
- *2025-10-20:* Documented the SDR odd-geometry pivot (config guide plus dedicated geometry notes), surfaced Rich console notifications for full-chroma promotions, and clarified that dithering only occurs during the final 16→8 RGB conversion while HDR behaviour remains unchanged.
- *2025-10-20:* Audited the new `zip(..., strict=True)` guards in geometry planning/rendering: confirmed they surface invariant breaks earlier (helpful for mismatched clip/plan lists or stale colour metadata), noted the trade-off that they now raise `ValueError` instead of silently truncating when callers mis-size inputs, and captured mitigation strategies (defensive asserts in planner tests and explicit list construction) so operational runs fail fast with actionable logs rather than partial renders.
- *2025-10-18:* When screenshot rendering receives VapourSynth clips without matrix/transfer metadata we now probe frame props and default to Rec.709 limited values so `resize.Point` can emit RGB24 without raising "no path between colours"; regression tests cover the fallback and metadata-preservation paths.
- *2025-10-17:* Finalised the VSPreview-assisted manual alignment UX, documenting the new flag in README/REFERENCE, expanding the audio-alignment guide with prerequisites and fallback behaviour, surfacing the hook in CLI help, and extending automated + manual QA coverage for the headless fallback path.
- *2025-10-16:* Enforced workspace containment for analysis cache and audio offset files via `_resolve_workspace_subdir`, added regression coverage for escape attempts, removed the generated `config.toml` (template remains the source of defaults), and limited automatic screenshot cleanup to directories created during the active run.
- *2025-10-16:* Constrained supported Python versions to 3.13.x (`>=3.13,<3.14`) because `librosa`/`numba` fail to build on 3.14; updated pyproject/lock files accordingly.
- *2025-10-14:* Locked workspace root discovery to `--root`/`FRAME_COMPARE_ROOT`/sentinel hierarchy, seeded config under `ROOT/config/config.toml`, enforced `ROOT/comparison_videos[/screens]` outputs, and added diagnostics + site-packages guardrails.
- *2025-10-12:* Default config seeding now targets `~/.frame-compare/config.toml`, the packaged template lives under `src/data/` with explicit package data so wheels retain it, and `[paths].input_dir` defaults to `~/comparison_videos` to avoid site-packages permission traps. *(superseded by 2025-10-14 workspace root lock.)*
- *2025-10-11:* `copy_default_config` now honours `$FRAME_COMPARE_TEMPLATE_PATH` and falls back to the repository template when the packaged `data` module is unavailable, letting us drop the setuptools package-dir mapping without breaking config seeding.
- *2025-10-11:* Screenshot generation wraps directory creation failures in `ScreenshotError` so permission-denied errors surface with actionable guidance about choosing a writable `[paths].input_dir`.
- *2025-10-09:* When the packaged install directory is read-only we now seed the default config under `~/.frame-compare/config.toml`, logging the relocation so users know to point overrides there instead of the site-packages path. *(legacy approach before 2025-10-14 root lock.)*
- *2025-10-10:* Restored the ability to disable FFmpeg screenshot timeouts by permitting `screenshots.ffmpeg_timeout_seconds = 0` and treating non-positive values as "no timeout" when invoking FFmpeg.
- *2025-10-18:* Added `screenshots.ffmpeg_timeout_seconds` plus `-nostdin` when spawning FFmpeg to stop runaway renders from freezing Windows shells; surfaced the timeout in CLI render metadata and config docs.
- *2025-10-17:* CLI layout tweaks: dropped the banner headline, repurposed the Analyze slot to show cached-metric reuse, removed the At-a-Glance crop-mod snippet in favour of resolved tonemap nits, and slimmed the Summary output block to avoid redundant frame counts.
- *2025-10-16:* Deep review flagged that `screenshots.directory_name` must be constrained to stay under the resolved input root before cleanup; follow-up will enforce containment checks before writing or deleting screenshot outputs (see `docs/deep_review.md`).
- *2025-10-15:* Relocated bundled comparison fixtures from `tests/fixtures/media/comparison_videos` to the repository-root
  `comparison_videos/` directory so CLI defaults, config templates, and contributor docs reference the same location as the
  fallback resolution added to `run_cli`.
- *2025-10-14:* Adjusted CLI theming to separate hierarchy (muted section badges, yellow subheads) and rewrote the At-a-Glance summary to surface sampling, window, and alignment metrics requested in the usability review.
- *2025-10-13:* Dropped the unused `types-pytest` dependency from the dev group because the package is unavailable on PyPI and broke `uv run` environment creation on fresh clones. CI keeps installing real `pytest` through the dev group, so workflows and local test runs continue to function normally.
- *2025-10-12:* Introduced local stubs for click, requests, httpx, and rich plus tighter JSON-tail helpers in tests to eliminate Pyright/Pylance import and indexing errors while keeping diagnostics strict.
- *2025-10-11:* Audited the `docs/` catalog, refreshed the deep-review memo with current safeguards/follow-ups, and corrected README reference defaults to match the live config schema.
- *2025-10-10:* Hardened CLI progress configuration by validating styles during config load, normalizing the stored value, and simplifying runtime flag handling to avoid getattr/except patterns flagged by linters.
- *2025-10-09:* Adjusted overlay text defaults so minimal mode now shows resolution/upscale context and frame-selection type while diagnostic mode drops per-frame selection detail lines that were redundant on-screen but remain available in cached metadata.
- *2025-10-02:* Restricted audio alignment's NumPy warning suppression to local contexts, paired with regression coverage that preserves global diagnostics while muting noisy dependencies.
- *2025-10-02:* Bounded the TMDB response cache to a configurable entry limit with TTL-aware eviction to stop unbounded growth flagged in deep-review performance findings.
- *2025-10-01:* Documented the audio alignment pipeline in `docs/audio_alignment_pipeline.md` to centralize requirements, workflow, and offsets file semantics for ongoing feature work.
- *2025-10-01:* Persisted selection metadata sidecar v1 with deterministic cache keys, JSON-tail exposure, and generated.compframes annotations to satisfy the CLI selection cache persistence guide.
- *2025-09-30:* Standardised group subhead styling across CLI sections: accent-subhead prefixes (`›`/`>` fallback), dim divider rules sized to block content, column alignment for numeric values, and verbose legends describing token roles to satisfy `features/CLI/GUIDE.md`.
- *2025-09-30:* Simplified diagnostic overlays by replacing the HDR MAX/AVG measurement block with render resolution, mastering display luminance (for HDR sources), and cached frame-selection metadata while trimming redundant frame-info lines to keep CLI banners uncluttered.
- *2025-09-19:* Adopted CLI layout styling DSL with semantic spans and data-driven highlight rules. Renderer now consumes palette roles (`value`, `unit`, `path`, etc.), honors section accent theming, and evaluates JSON-configured thresholds (e.g., tonemap verification, boolean states) to keep formatting declarative.
- *2025-10-14:* Adopted key/value styling in the CLI Summary list to mirror At-a-Glance key/value formatting and keep closing metrics aligned.
