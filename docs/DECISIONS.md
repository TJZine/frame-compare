# Decisions Log

- *2025-11-12:* Phase 11.6 — split `vs_core` by concern per `docs/refactor/mod_refactor.md`. Added the `src/frame_compare/vs/` subpackage (`env`, `source`, `props`, `color`, `tonemap`) with verbatim moves from `src/vs_core.py`, wired intra-package imports with `TYPE_CHECKING` guards, and replaced `src/vs_core.py` with a compatibility shim plus `.pyi` stub that proxies `_vs_module`, `_compute_luma_bounds`, `_detect_rgb_color_range`, `_apply_post_gamma_levels`, `_tonemap_with_retries`, etc., so existing monkeypatches keep working until Sub-phase 11.10 removes it. Updated `importlinter.ini` to include `src.frame_compare.vs` (and its modules) in the Runner→Core→Modules layer. After installing the `preview` extra locally, verification (2025-11-12): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 2]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.03 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.5 packaging cleanup — relocated `src/{cli_layout,report,slowpics,config_template}.py` (and their `.pyi` shims) into `src/frame_compare/`, updated the legacy modules to proxy the canonical module via `sys.modules[__name__] = _real_module` so monkeypatches hit the right globals, removed `Legacy/comp.py`, added `tests/__init__.py`, and appended the new modules to the Runner→Core→Modules layer in `importlinter.ini`. Added VSPreview extras locally (`uv pip install vspreview PySide6`) to satisfy the slow.pics tests. Verification (2025-11-12): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 1]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.96 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`. No external sources consulted.

# Decisions Log

- *2025-11-12:* Phase 11.4 logging normalization — replaced direct `print()`/`rich.print()` calls in `src/frame_compare/config_writer.py`, `src/frame_compare/core.py`, `src/frame_compare/runner.py`, `src/frame_compare/selection.py`, `src/frame_compare/tmdb_workflow.py`, and `src/screenshot.py` with module loggers, reporter console output, or Click echoes per the tracker scope; `selection.log_selection_windows` now accepts an optional reporter to preserve Rich formatting when present, and `tmdb_workflow` gained a `_style` helper to keep Click-based coloring without bringing Rich into the workflow module. Updated `docs/runner_refactor_checklist.md` best-practice anchors to clarify that only CLI presentation layers (and the generated VSPreview script) may call `print()`. Verification (2025-11-12): `git status -sb` → `## runner-refactor...origin/runner-refactor`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.02 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `uv run --no-sync lint-imports --config importlinter.ini` initially failed with “Operation not permitted” while reading the shared UV cache, reran with `UV_CACHE_DIR=.uv_cache` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.3 subprocess hardening landed. Added `src/frame_compare/subproc.py::run_checked` (argv-only, `shell=False`, stdio defaults, optional `check` raising `CalledProcessError`), refactored `src/screenshot.py`, `src/frame_compare/vspreview.py`, and `src/audio_alignment.py` to route FFmpeg/FFprobe/VSPreview invocations through the helper (preserving timeout handling and error messages), and updated the screenshot timeout/command-construction tests to monkeypatch `src.frame_compare.subproc.run_checked`. `importlinter.ini` now lists `src.frame_compare.subproc` in the Runner→Core→Modules contract, and documentation trackers are updated for Sub-phase 11.3. Verification (2025-11-12): `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken` (initial run without `UV_CACHE_DIR` failed with “Operation not permitted” while touching the shared cache). References: source:https://github.com/python/cpython/blob/main/Doc/library/subprocess.rst@2025-11-12 (Context7, Markdown chunk “Handle subprocess.Popen TimeoutExpired Exception in Python”) — ensures `run_checked` propagates `TimeoutExpired` so callers can preserve the existing FFmpeg error mapping; source:https://github.com/python/cpython/blob/main/Doc/library/subprocess.rst@2025-11-12 (Context7, Markdown chunk “Execute Shell Command with Error Checking in Python”) — confirms `check=True` should raise `CalledProcessError`, matching the helper’s optional `check` semantics.
- *2025-11-12:* Phase 11.2 split landed. Created `src/frame_compare/analysis/{__init__,cache_io,metrics,selection}.py`, moved the corresponding sections out of `src/analysis.py`, and left the old module as a thin shim that re-exports the legacy API (including the `_collect_metrics_*` helpers the tests patch). Selection now depends on the new modules via public aliases, and cache IO lazily imports the selection serializers under `TYPE_CHECKING` to keep cycles at bay. Added `# pyright: standard` headers in the three new modules so the rest of `src/frame_compare` can remain `strict` without forcing a rewrite of the legacy analysis types, and updated `importlinter.ini` to extend the Runner→Core→Modules contract with `src.frame_compare.analysis`. Verification (2025-11-12): `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.06 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken` (first attempt hit a permission error reading the default UV cache).
- *2025-11-12:* Phase 11.2 review — Verified the analysis package split on the documentation tracker/checklist, confirmed the shim still exposes the patched helpers, and re-ran the required quartet plus import-linter after the doc updates. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 30]` with only `docs/refactor/mod_refactor.md` and `docs/runner_refactor_checklist.md` staged; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.3 review — Confirmed the subprocess hardening refactor (subproc helper + ffmpeg/ffprobe/vspreview call sites) matches the plan, updated trackers/checklist entries, and reran the verification suite after the documentation edits. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 31]` with only docs staged; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 39.99 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `UV_CACHE_DIR=.uv_cache uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`.
- *2025-11-12:* Phase 11.1 planning — Render helpers extraction. Planned `src/frame_compare/render/` package with `naming.py`, `geometry.py`, `overlay.py`, `encoders.py`; identified pure helpers to move from `src/screenshot.py` with wrappers to preserve behavior and test imports. Anchors recorded: naming (`src/screenshot.py:1957`, `:1965`, `:1971`, plus pattern at `:38`), overlay text/state (`:80`, `:133`, `:144`, `:194`, `:248`, `:266`, `:286`, `:308`, `:321`, styles at `:813`, `:817`), encoders (`:1975`, `:1983`, `:1988`, `:2345`, `:2351`), geometry helpers (`:154`, `:1135`, `:1146`, `:1377`, `:1398`, `:1440`, `:1479`, plus split/align at ~`:1556`, `:1568`, and scaled dims at ~`:1602`, describe axes at `:1157`). Kept `GeometryPlan` in `src/screenshot.py` for this sub‑phase. Verification gates set: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, and import‑linter after adding the new package to the modules layer. No external sources used; Serena MCP file/pattern search used to locate anchors.
- *2025-11-12:* Phase 11.2 planning — Analysis split (`metrics.py`, `selection.py`, `cache_io.py`). Planned new package `src/frame_compare/analysis/` and a shim in `src/analysis.py` (to be removed in 11.10). Anchors recorded (src/analysis.py): metrics `_quantile` (~371), `_frame_rate` (~1175), `_is_hdr_source` (~1258), `_collect_metrics_vapoursynth` (~1282), `_generate_metrics_fallback` (~1518), `_smooth_motion` (~1548); selection `SelectionWindowSpec` (~90), `SelectionDetail` (~131), `_frame_to_timecode` (~216), `_coerce_seconds` (~433), `compute_selection_window` (~457), `selection_details_to_json` (~354), `_serialize_selection_details` (~289), `_deserialize_selection_details` (~306), `_format_selection_annotation` (~341), `_selection_fingerprint` (~549), `selection_hash_for_config` (~579), `dedupe` (~1146), `select_frames` (~1571); cache IO dataclasses (`FrameMetricsCacheInfo` ~47, `CachedMetrics` ~62, `CacheLoadResult` ~81), `_threshold_snapshot` (~393), `_config_fingerprint` (~409), `_atomic_write_json` (~240), `_compute_file_sha1` (~268), sidecar functions (`_selection_sidecar_path` ~737, `_build_clip_inputs` ~755, `_selection_cache_key` ~784, `_selection_payload_from_inputs` ~800, `_build_selection_sidecar_payload` ~830, `_save_selection_sidecar` ~848, `write_selection_cache_file` ~927, `_load_selection_sidecar` ~985), cache probe (`probe_cached_metrics` ~585, loader ~720). Verification gates set: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, `uv run --no-sync lint-imports --config importlinter.ini` after appending `src.frame_compare.analysis` to the modules layer. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.3 planning — Subprocess hardening. Planned `src/frame_compare/subproc.py` with `run_checked(argv, *, cwd=None, env=None, timeout=None, stdin=DEVNULL, stdout=PIPE, stderr=PIPE, text=True, check=False) -> CompletedProcess[str]` (always `shell=False`), and refactors in `src/screenshot.py` (ffmpeg writer), `src/frame_compare/vspreview.py` (launcher default runner), and `src/audio_alignment.py` (ffprobe/ffmpeg probing and extract) to use it. Anchors recorded: screenshot ffmpeg run block (~2375–2520); vspreview runner default (~959) and call site (~970); audio_alignment `probe_audio_streams` (~119–167), `_extract_audio` (~206–245), `_probe_fps` (~292–323). Tests to update: `tests/test_screenshot.py` monkeypatch targets switched from `screenshot.subprocess.run` to `src.frame_compare.subproc.run_checked` in timeout and filter‑chain tests. Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, and import‑linter after adding `src.frame_compare.subproc` to the modules layer. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.4 planning — Logging normalization. Normalize logging across library modules, replacing direct `print()`/`rich.print()` with module loggers or reporter calls, excluding the VSPreview generated script prints. Anchors recorded:
   - config_writer: `_present_diff` prints (~211–227).
   - runner: selection exception prints (~1255–1256) and slow.pics upload note (~1722).
   - core: analyze‑file selection note (~265).
   - selection: `from rich import print` (~8); prints at ~57, ~171–177, ~187, ~193–195; add optional reporter to `log_selection_windows`.
   - screenshot: overlay debug prints (~1848–1854, ~1877–1882, ~1932–1937) gated by `FRAME_COMPARE_LOG_OVERLAY_RANGE`.
   - tmdb_workflow: interactive guidance prints (~215–221, ~233, ~245–247, ~261) to migrate to `click.echo` or reporter.
   Exclusions: VSPreview script `safe_print` and `print()` lines in the persisted script (covered by `tests/test_console_safety.py`). Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, `uv run --no-sync lint-imports --config importlinter.ini`. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.5 planning — Packaging cleanup + legacy removal. Plan to relocate internal modules from `src/` to `src/frame_compare/` with thin shims left in place until 11.10; remove `Legacy/comp.py`. Moves: `src/cli_layout.py` → `src/frame_compare/cli_layout.py`, `src/report.py` → `src/frame_compare/report.py`, `src/slowpics.py` → `src/frame_compare/slowpics.py`, `src/config_template.py` → `src/frame_compare/config_template.py`. Shims at old paths re‑export `*` with `# type: ignore[F401,F403]`. Import‑linter layer to include `src.frame_compare.{cli_layout,report,slowpics,config_template}`. Exclusions for this sub‑phase: keep `src/datatypes.py`, `src/utils.py`, `src/tmdb.py`, `src/screenshot.py`, `src/vs_core.py`, and `src/analysis.py` shim. Anchors: file paths above and import sites in tests (`tests/cli/test_layout.py` imports `src.cli_layout`; `tests/test_report.py` imports `src.report`; `tests/test_slowpics.py` imports `src.slowpics`; `tests/test_config_template.py` imports `src.config_template`). Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, and import‑linter after layer update. No external sources used; anchors gathered via Serena search.
 - *2025-11-12:* Phase 11.6 planning — vs_core split by concerns. Plan to introduce `src/frame_compare/vs/{env,source,props,color,tonemap}.py` and a compatibility shim in `src/vs_core.py` that re-exports all used names (public and private helpers), to be removed in 11.10. Anchors recorded (src/vs_core.py): env/config (~21–28, ~229–360, ~326, ~1134), source/open/trim (plugin constants ~17–22; error classes ~41–76; `_set_source_preference` ~300; `_resolve_core` ~366; `_slice_clip` ~1056; `_extend_with_blank` ~1070; `_apply_fps_map` ~1090; `init_clip` ~1104), props/color extraction (mappings/labels ~138–227; `_describe_code` ~229; `_props_signal_hdr` ~736; `_coerce_prop` ~750; `_first_present` ~768; `_normalise_resolved_code` ~774; `_resolve_color_metadata` ~778; `_infer_frame_height` ~812; `_extract_frame_props` ~1186; `_snapshot_frame_props` ~1196), color normalization (`_resolve_configured_color_defaults` ~834; `_adjust_color_range_from_signal` ~1208; `normalise_color_metadata` ~1228; plus `_resolve_color_overrides`/`_guess_default_colourspace`), tonemap/verification (`TonemapInfo` ~92; `VerificationResult` ~121; `ColorDebugArtifacts` ~137; `TonemapSettings` ~150; `_parse_unexpected_kwarg` ~1872; `_call_tonemap_function` ~1898; `_apply_post_gamma_levels` ~1926; `_compute_verification` ~1969; `process_clip_for_screenshot` ~2010; `ClipProcessError`). Verification gates: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`, `.venv/bin/ruff check`, `.venv/bin/pyright --warnings`, `uv run --no-sync lint-imports --config importlinter.ini`. No external sources used; anchors gathered via Serena search.
- *2025-11-12:* Phase 11.1 render helpers extraction completion. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 28]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `289 passed, 1 skipped in 40.19 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken` (initial `uv` call hit a cache permission error and was re-run with elevated access). Added `src/frame_compare/render/{__init__,errors,encoders,geometry,naming,overlay}.py`, moved the pure helpers from `src/screenshot.py` with thin private wrappers, and updated `importlinter.ini` to include the new package in the modules layer. Created focussed suites under `tests/render/test_{naming,overlay_text,encoders,geometry_helpers}.py`, refreshed `docs/refactor/mod_refactor.md` (Phase 11 tracker + 11.1 notes), and added the Phase 11.1 checklist section to `docs/runner_refactor_checklist.md` alongside this DEC entry so the tracker + quartet remain in sync.
- *2025-11-12:* Phase 10.2 TMDB shim removal. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 25]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.99 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`. Deleted the transitional TMDB forwarders from `src/frame_compare/core.py`, dropped the `_resolve_tmdb_blocking` compat export in `frame_compare._COMPAT_EXPORTS`, updated runner helpers/tests (`tests/helpers/runner_env.py`, `tests/runner/test_cli_entry.py`, `tests/runner/test_slowpics_workflow.py`) to patch `tmdb_workflow` directly, refreshed typings + docs (README, config audit, tracker logs), and recorded the checklists for Phase 10.2.
 - *2025-11-12:* Documentation audit kickoff for Serena MCP integration. Updated `agents.md` to prioritize Serena for evidence sweeps (symbol/pattern search, sequential-thinking, project memory) and clarified Advisor verify behavior. Updated `CODEX.md` to add Serena as primary orchestration for code awareness and symbol-safe operations, list Serena analysis calls and mode changes under always-allowed checks, add missing Test Guardrails, and expand the “Always-logged MCP calls” rule to include Serena. Adjusted planning fallback to prefer Serena think tools → Sequential Thinking MCP → bullet outline. Updated `.serena/project.yml` to add an initial prompt and ignore heavy media paths.
   Sources (Context7):
   - source:https://github.com/delano/zed-mcp-server-serena/blob/main/QUICK_START.md@2025-11-12T07:25:23Z — confirms Serena MCP tool surface (get_symbols_overview, find_symbol, etc.) and extension behavior.
   - source:https://github.com/delano/zed-mcp-server-serena/blob/main/DEVELOPING.md@2025-11-12T07:25:23Z — shows `serena start-mcp-server` usage and `serena-agent` installation.
   - source:https://github.com/oraios/serena/blob/main/DOCKER.md@2025-11-12T07:25:23Z — documents `serena-mcp-server` and `--context ide-assistant`, Docker/Compose usage.
 - *2025-11-12:* Enable Markdown LSP in Serena. Added `markdown` to `.serena/project.yml:languages` so Serena’s symbol/outline and diagnostics work on docs (`*.md`), improving doc edits and heading-aware navigation alongside code work.
- *2025-11-12:* Phase 10.1 TMDB workflow extraction. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 24]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.12 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Added `src/frame_compare/tmdb_workflow.py` to host `TMDBLookupResult`, retry/backoff helpers, prompts, and collection rendering; rewired `runner.py`, curated exports (`frame_compare._COMPAT_EXPORTS`, typings), and the CLI tests to patch the new module, while `core.py` now exposes thin forwarders for one release plus prompt wrappers that delegate into `tmdb_workflow`. Reference: source:https://github.com/python/cpython/blob/v3.11.14/Doc/library/dataclasses.rst@2025-11-12T20:06:00Z (Context7 “Define a Dataclass in Python”) — confirmed the dataclass contract stayed intact as we moved `TMDBLookupResult`.
- *2025-11-12:* Phase 9.12 Runner API docs + examples. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 23]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Added a standalone “Programmatic Runner API” section (RunRequest/RunResult example, CLIAppError handling, RunResult output access), a “Programmatic Doctor (dependency checks)” example, curated import/typing guidance, and quick recipes in `README.md`, plus the new “API Reference” section in `docs/README_REFERENCE.md`. Tracker row 9.12 and the Phase 9.12 session checklist now document the docs-only work—quartet outcomes remain green since no runtime code changed.
- *2025-11-11:* Phase 9.10 selection public `__all__` contract. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 22]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.91 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Ensured `src/frame_compare/selection.py` declares `__all__ = ["init_clips", "resolve_selection_windows", "log_selection_windows"]` (typed as `Final`) so wildcard imports stay limited to the documented helpers, per Python’s guidance on constraining package exports. Tracker row flipped to ☑ in `docs/refactor/mod_refactor.md` and the Phase 9.10 session checklist was logged with the quartet outputs. Reference: source:https://github.com/python/cpython/blob/v3.11.14/Doc/tutorial/modules.rst@2025-11-11T11:51:18Z (Context7, “Packages” — defining `__all__` so `from package import *` only exposes expected names).
- *2025-11-11:* Phase 9.9 CLI test relocation. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 21]`; baseline `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.93 s`. Moved the remaining CLI suites into `tests/cli/` (`test_wizard.py`, `test_doctor.py`, `test_help.py`, `test_layout.py`) and added `tests/cli/__init__.py` so pytest treats the folder as a package—otherwise it attempted to import both `tests/cli/test_wizard.py` and `tests/test_wizard.py` as the same `test_wizard` module. Targeted confidence runs: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q tests/cli/test_doctor.py` → `2 passed in 0.01 s`; `... test_wizard.py` → `7 passed in 0.04 s`; `... test_help.py` → `1 passed in 0.01 s`; `... test_layout.py` → `2 passed in 0.01 s`. Post-move `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` stayed at `273 passed, 1 skipped in 39.90 s`, `.venv/bin/ruff check` reported `All checks passed!`, and `.venv/bin/pyright --warnings` reported `0 errors, 0 warnings, 0 informations`. Tracker + Session Checklist updated in `docs/refactor/mod_refactor.md` along with a DECISIONS entry describing the relocation. Reference: source:https://github.com/pytest-dev/pytest/blob/main/doc/en/example/pythoncollection.md@2025-11-11T06:30:05Z (Context7, “Customizing pytest's Python test naming conventions”) — confirms pytest derives module names from file paths and that packaging directories (`__init__.py`) keeps modules uniquely qualified when duplicate basenames exist.
- *2025-11-11:* Phase 9.9 doc/CI audit. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 21]`; `rg -n "tests/test_cli_"` (plus `rg -n "test_cli"` across `.github/`) showed only documentation references after the file moves, so automation globs already point at the right directories. Updated `docs/config_audit.md`, `docs/runner_refactor_checklist.md`, `docs/refactor/mod_refactor.md`, and this log to cite `tests/cli/test_*.py` (with parenthetical notes for the pre-Phase 9.9 names) so future contributors don’t chase deleted files. No code or CI changes were required; the audit confirms all commands/tests now use the `tests/cli/` layout.
- *2025-11-11:* Phase 9.9 documentation audit + verification. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 21]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.00 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Synced `docs/runner_refactor_checklist.md` and `docs/refactor/mod_refactor.md` with the new `tests/cli/` structure (Phase 9.9 checklist + narrative) so reviewers know the relocation is complete and the pytest package marker rationale is documented. No code changes were necessary; this entry captures the verification quartet after the doc updates.
- *2025-11-11:* Phase 9.8 documentation audit + verification. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 20]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.04 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Reconciled the Phase 9 trackers so `docs/runner_refactor_checklist.md` and `docs/refactor/mod_refactor.md` both document the shim removals completed in Phase 9.8, added the missing checklist section, and noted that curated exports now point straight to the extracted modules. No code changes were required because the removals already lived on the branch; Phase 10 scope (TMDB + wizard shims) remains unchanged.
- *2025-11-11:* Phase 9.7 import contracts and CI enforcement. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 19]`; `uv run --no-sync lint-imports --config importlinter.ini` → `Contracts: 3 kept, 0 broken`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.94 s`. Added `importlinter.ini` with the runner→core→modules layering contract plus forbidden module→CLI/core barriers (temporary ignore noted for the existing runner→core shim), taught the lint workflow job to install and run `lint-imports` (the package only exposes that entrypoint, so `python -m importlinter` isn’t available), and tweaked `pyproject.toml`/`tests/cli/test_doctor.py` (renamed from `tests/test_cli_doctor.py`) so Ruff classifies `frame_compare` as first-party and keeps the import order stable. Reference: source:https://github.com/seddonym/import-linter/blob/master/docs/contract_types.rst@2025-11-11T05:27:30Z (Context7, “Layers Contract Configuration Reference” + “Forbidden Modules Contract Configuration Reference”) — confirms layers are ordered from higher→lower modules without wildcards and that forbidden contracts support ignore lists for curated exceptions.
- *2025-11-11:* Phase 9.8 legacy-shim removal. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 20]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.96 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Deleted the redundant doctor/config-writer/presets/metadata/selection forwarders from `src/frame_compare/core.py`, updated the TMDB workflow to call `metadata.first_non_empty`/`parse_year_hint` inline, and replaced the bespoke `collect_doctor_checks` wrapper in `frame_compare.py` with a direct alias to `doctor_module.collect_checks` so `_COMPAT_EXPORTS` exposes the real modules instead of the old shims. Tracker + Session Checklist updated in `docs/refactor/mod_refactor.md`. Reference: source:https://github.com/python/cpython/blob/v3.11.14/Doc/tutorial/modules.rst@2025-11-11T10:40:44Z (Context7, snippet “Import a Python module with an alias”) — reiterates that curated APIs should expose the actual module object so downstream callers don’t rely on redundant wrappers.
- *2025-11-11:* Phase 9.6 fixture cleanup plan + representative refactors. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 18]`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.13 s`. Added `VSPreviewPatch`, `install_vspreview_presence`, and `install_which_map` under `tests/helpers/runner_env.py`, introduced the `vspreview_env`, `which_map`, and `cli_env` fixtures in `tests/conftest.py`, and refactored `tests/cli/test_doctor.py` (formerly `tests/test_cli_doctor.py`) plus `tests/runner/test_audio_alignment_cli.py` to consume them while keeping legacy `_patch_*` helpers for back-compat. Updated `docs/refactor/mod_refactor.md` with the Phase 9.6 checklist and the CLI test split plan (`tests/cli/test_wizard.py` + `tests/cli/test_doctor.py` in Phase 10). Reference: source:https://github.com/pytest-dev/pytest/blob/main/doc/en/how-to/fixtures.md@2025-11-11T09:52:27Z (Context7, excerpt on composing fixtures) — reinforces returning callables/objects from fixtures instead of calling them directly.

- *2025-11-11:* Phase 9.5 curated exports + typing surface. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 17]`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.98 s`. Updated `frame_compare._COMPAT_EXPORTS` so VSPreview helpers, doctor module, presets, and config_writer are surfaced from their dedicated modules (doctor helpers also exposed as `collect_doctor_checks` / `emit_doctor_results` / `DoctorCheck`), refreshed `typings/frame_compare.pyi` accordingly, and added `src/frame_compare/py.typed` plus the MANIFEST include so type checkers recognize the package as typed. Reference: source:https://github.com/python/peps/blob/main/peps/pep-0561.rst@2025-11-11T08:20:53Z (Context7, snippet “Configuring package_data for py.typed marker - Python”) — documents the requirement to ship a `py.typed` marker via package data for PEP 561 compliance.

- *2025-11-11:* Phase 9.4 selection/init helper extraction. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 16]`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.89 s`. Added `src/frame_compare/selection.py` with local `_extract_clip_fps`, TYPE_CHECKING-only imports, and the migrated `init_clips`/`resolve_selection_windows`/`log_selection_windows` helpers; `runner.py` now imports `selection_utils` while `src.frame_compare.core` exposes shim forwarders for compatibility. Updated `docs/refactor/mod_refactor.md` (Phase 9.4 row + Session Checklist) and this log with the verification outputs. Reference: source:https://github.com/python/cpython/blob/v3.11.14/Doc/library/typing.rst@2025-11-11T08:02:55Z (Context7, Markdown chunk “Conditionally Import and Annotate with TYPE_CHECKING”) — reaffirms guarding heavy imports behind `TYPE_CHECKING` to avoid runtime cycles while keeping annotations intact.
- *2025-11-11:* Phase 9.5 curated exports + typing. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 17]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.90 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. `frame_compare._COMPAT_EXPORTS` now includes the dedicated doctor/config_writer/presets modules plus VSPreview helpers, `typings/frame_compare.pyi` exposes the doctor APIs, and `src/frame_compare/py.typed` (included via `MANIFEST.in`) marks the package as typed for PEP 561 consumers. No README/CHANGELOG changes were needed because the exported symbols remain backwards compatible; future work (Phase 9.6) will focus on fixture cleanup planning before we drop the remaining shims.

- *2025-11-11:* Phase 9.3 runner unhook (trivial callers). `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 16]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.01 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Added `src/frame_compare/runtime_utils.py` (fps/time/summary helpers), moved the simple metadata helpers into `src/frame_compare.metadata`, switched `runner.py` to import VSPreview constants + `_abort_if_site_packages` from their dedicated modules, and updated `docs/refactor/mod_refactor.md` + this log to mark Phase 9.3 complete while keeping `core` shims for compatibility. No new README/CHANGELOG entries required because behavior stayed internal.

- *2025-11-11:* Phase 9.2 verification (post-review). `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 15]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.89 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Confirmed `config_writer.py` / `presets.py` own the template + preset flows, `frame_compare.py` imports them directly, and `src.frame_compare.core` keeps shims until Phase 9.5’s curated-export cleanup.

- *2025-11-11:* Phase 9.2 config-writer/presets extraction: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 14]`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 39.95 s`. Added `src/frame_compare/config_writer.py` (read/load/render/write helpers) and `src/frame_compare/presets.py`, rewired `frame_compare.py` to import them directly, and kept `src.frame_compare.core` forwarders for `_read_template_text` et al. No external docs were required beyond existing module references.

- *2025-11-11:* Phase 9.1 doctor extraction verification. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 14]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.98 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. `src/frame_compare/doctor.py` now owns the dependency checks, `frame_compare.py` routes both the `doctor` command and wizard prompts through `doctor_module`, and `src/frame_compare/core` retains `_collect_doctor_checks` / `_emit_doctor_results` shims until Phase 9.5 finalizes the curated exports.

- *2025-11-11:* Phase 9.1 (doctor extraction) landed. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 13]` before commit prep; created `src/frame_compare/doctor.py` with `DoctorCheck`, `collect_checks`, and `emit_results`, rewired the doctor CLI + wizard dependency check to call the module, and left `src.frame_compare.core` shims delegating for compatibility (tests still patch `core.importlib.util`). Tracker docs updated (`docs/refactor/mod_refactor.md` Phase 9.1 row ☑, `docs/runner_refactor_checklist.md` Phase 9 section) plus `CHANGELOG.md` now records the module move. Verification (2025-11-11): `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.96s`.
- *2025-11-11:* Phase 8 documentation & cleanup complete. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 13]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.92 s`; `.venv/bin/ruff check` → `All checks passed!`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. README now explains the `tests/runner/*` split + shared fixtures, CHANGELOG captures the runner test restructure/VSPreview guardrails, `docs/runner_refactor_checklist.md` gained the Phase 8 row, and `docs/refactor/mod_refactor.md` marks Phase 8 as ☑ with references to this entry. No residual Ruff/Pyright debt remains.

- *2025-11-11:* Phase 8 completion. README (Contributing) now points contributors to the `tests/runner/` layout, shared fixtures in `tests/helpers/runner_env.py`, and the VSPreview guardrails; `CHANGELOG.md` captures the Phase 6–7 runner test split + fail-fast shim; `docs/runner_refactor_checklist.md` and `docs/refactor/mod_refactor.md` both gained Phase 8 sections noting the doc refresh, Ruff decision, and verification references. Verification after the edits (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 12]` with the updated docs; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.96 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Residual risk: `tests/runner/test_audio_alignment_cli.py::test_audio_alignment_vspreview_constants_raise_when_missing` still reloads `tests.helpers.runner_env` to simulate disappearing VSPreview exports, so we reset the module immediately afterward to avoid leaking state into other tests—leave the guard in place until pytest offers a smoother import-hook.
- *2025-11-11:* Phase 8 prep & doc planning. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 12]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.92 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Ruff no longer flags the previously noted import-order/unused-import debt, so Phase 8 can focus on documentation unless new warnings surface. Doc reference for the upcoming README/handbook updates: pytest fixture composition keeps shared helpers reusable across modules when they’re requested via parameters instead of direct calls (source:https://github.com/pytest-dev/pytest/blob/main/doc/en/how-to/fixtures.md@2025-11-11); this underpins the shared `tests/helpers/runner_env.py` fixtures we’re now documenting.
- *2025-11-11:* Phase 7 VSPreview shim validation kickoff. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 11]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 39.88 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings`. Scope: tighten the VSPreview test shims so missing CLI exports raise immediately, add regression coverage in `tests/runner/test_audio_alignment_cli.py`, and document each verification pass in Phase 7 per Pyright’s `Final` guidance (source:https://github.com/microsoft/pyright/blob/main/docs/typed-libraries.md@2025-11-11).
- *2025-11-11:* Phase 7 shim enforcement complete. `tests/helpers/runner_env.py` now routes `_VSPREVIEW_WINDOWS_INSTALL`/`_VSPREVIEW_POSIX_INSTALL` through `_require_vspreview_constant`, which raises `RuntimeError` when `frame_compare` stops exporting the CLI shims (per Pyright’s `Final` constant guidance; source:https://github.com/microsoft/pyright/blob/main/docs/typed-libraries.md@2025-11-11). `tests/runner/test_audio_alignment_cli.py::test_audio_alignment_vspreview_constants_raise_when_missing` monkeypatches the exports away, reloads `tests.helpers.runner_env`, and asserts the import fails so pytest catches shim drift immediately. Verification (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 11]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped, 39.99 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`. Residual risk: the reload-based regression test temporarily mutates `tests.helpers.runner_env`, so it restores the module immediately after to keep other suites stable.
- *2025-11-11:* VSPreview manual offset persistence fix. `src/frame_compare/vspreview.py` now records manual VSPreview adjustments as per-clip deltas when calling `audio_alignment.update_offsets_file`, and `_reuse_vspreview_manual_offsets_if_available` reconstructs absolute trims by adding the stored delta back to each clip’s baseline trim. This keeps the offsets TOML + CLI telemetry consistent with auto alignment so future runs don’t over-trim. Verification: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 40.00 s`; `.venv/bin/ruff check` → `All checks passed`; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings`. Residual risk: manual reuse still skips seconds metadata in JSON (`offsets_sec` remains empty) but the runner surfaces the applied trims via `manual_trim_starts`, so no behavioral regression was observed.
- *2025-11-11:* Phase 6.3 runner test polish kick-off. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]` (existing staged docs/src work plus the new `tests/helpers/` + `tests/runner/` trees from earlier sub-phases); `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 40.09 s`; `.venv/bin/ruff check` still fails on the repo-wide import-order/unused-import debt in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py`; `.venv/bin/pyright --warnings` reports the known `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute errors inside `tests/runner/test_audio_alignment_cli.py` plus the Final reassignment errors in `typings/frame_compare.pyi`. Scope for this sub-phase: finish the shared `dummy_progress` fixture, add a typed VSPreview shim for the audio-alignment tests, consolidate helpers, and re-run the verification quartet once the runner suites no longer rely on per-file patches.
- *2025-11-11:* Phase 6.3 runner test polish complete. Added `install_dummy_progress` + `dummy_progress` fixture so every runner suite automatically stubs Rich `Progress`, and centralised the VSPreview shim (`_format_vspreview_manual_command`, `_VSPREVIEW_*` typed constants) in `tests/helpers/runner_env.py` per Pyright’s constant guidance (source:https://github.com/microsoft/pyright/blob/main/docs/typed-libraries.md@2025-11-10). `tests/runner/test_audio_alignment_cli.py` now imports the shim directly, slow.pics/TMDB suites stopped calling `_patch_*("Progress", DummyProgress)`, and the helper audit confirmed no additional inline utilities needed relocation. Final verification (2025-11-11): `git status -sb` → unchanged `## runner-refactor...origin/runner-refactor [ahead 8]` with the existing staged docs/src backlog plus the in-flight runner test edits; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `272 passed, 1 skipped, 40.20 s`; `.venv/bin/ruff check` still fails on the long-standing import-order/unused-import issues in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py` only; `.venv/bin/pyright --warnings` → `0 errors, 0 warnings`. Residual risks: Ruff debt in the alignment/runner modules remains untouched, and the alignment-runner typing backlog recorded earlier is still open but no longer blocks the relocated runner suites.
- *2025-11-11:* Phase 6.2 runner test split landed. Created `tests/runner/test_cli_entry.py`, `tests/runner/test_audio_alignment_cli.py`, and `tests/runner/test_slowpics_workflow.py`, leaving `tests/test_frame_compare.py` as a shim-only regression suite with a relocation map. Introduced shared fixtures in `tests/conftest.py` (`runner`, `runner_vs_core_stub`) and moved `_expect_mapping`, `_patch_load_config`, `_selection_details_to_json`, and `DummyProgress` into `tests/helpers/runner_env.py` so every runner-focused module consumes the same helpers. Baseline commands (2025-11-11): `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]` (existing staged docs/src work plus new `tests/helpers/` and `tests/runner/` folders); `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (272 passed, 1 skipped, 40.43 s); `.venv/bin/ruff check` still fails on the long-standing import-order/unused-import warnings in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py`; `.venv/bin/pyright --warnings` raised the known `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute errors in `tests/test_frame_compare.py` plus the Final reassignment errors in `typings/frame_compare.pyi`. Post-split verification: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (272 passed, 1 skipped, 40.09 s); `.venv/bin/ruff check` continues to fail on the same pre-existing modules (no new runner warnings after the split/fixes); `.venv/bin/pyright --warnings` now reports the `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute and Final errors out of `tests/runner/test_audio_alignment_cli.py` and `typings/frame_compare.pyi` (the shim symbol gaps moved with the tests). Docs updated: `docs/refactor/mod_refactor.md` progress tracker (Phase 6.1 + 6.2 rows now ☑), `docs/runner_refactor_checklist.md` (Phase 6.2 subsection recording destinations/fixtures/residual risks), `docs/config_audit.md` + `docs/audio_alignment_pipeline.md` (all references now point at the new runner test modules instead of the monolith), and `docs/DECISIONS.md` (this entry). Residual risks: slow.pics progress patching still relies on `DummyProgress` via `_patch_core_helper` (flagged for Phase 6.3), and the repo-wide Ruff/Pyright blockers remain unchanged.

- *2025-11-11:* Phase 6.1 shared fixtures landed: created `tests/helpers/runner_env.py` with `_CliRunnerEnv`, `_patch_*`, `_make_config`, JSON/VSPreview stubs, plus `tests/conftest.py` fixtures (`cli_runner_env`, `recording_output_manager`, `json_tail_stub`). Updated `tests/test_frame_compare.py`, `tests/test_alignment_runner.py`, and `tests/test_vspreview.py` to import from the shared helpers so future splits avoid circular imports. `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]` (docs + helper/test edits staged alongside unrelated pending files). Verification: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (272 passed, 1 skipped, 40.00 s); `.venv/bin/ruff check` still fails on the pre-existing import-order/unused-import warnings in `src/frame_compare/alignment_runner.py`, `src/frame_compare/cli_runtime.py`, `src/frame_compare/runner.py`, `src/screenshot.py`, and `tests/test_alignment_runner.py`; `.venv/bin/pyright --warnings` continues to report the known `_format_vspreview_manual_command`/`_VSPREVIEW_*` attribute/Final errors in `tests/test_frame_compare.py` and `typings/frame_compare.pyi`. Residual risk: helper extraction is clean, but repo-level Ruff/Pyright gates remain blocked on the longstanding alignment/VSPREVIEW shim issues.

- *2025-11-10:* Phase 4.2 VSPreview polish landed: runner now calls `alignment_runner.apply_audio_alignment` directly, `_write_vspreview_script` splits rendering/writes, `_launch_vspreview` logs missing executables/`VAPOURSYNTH_PYTHONPATH` with injectable subprocess runners, and `_apply_vspreview_manual_offsets` keeps JSON-tail `offsets_sec`/`offsets_frames` in sync while warning on unknown clip names. Added `tests/test_alignment_runner.py` for script persistence, launcher injection, and manual-offset telemetry. Reference: librosa onset-detection guidance for trim heuristics (source:https://librosa.org/doc/latest/onset @2025-11-10 via Context7). Verification commands: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 8]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (270 passed, 1 skipped, 40.08 s); `.venv/bin/ruff check` (clean); `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1` remains required to sidestep third-party plugins in this environment.
- *2025-11-10:* Phase 3.2 prep: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 5]`; `pytest -q` (209 passed, 54 skipped, 39.80 s); `.venv/bin/ruff check` (All checks passed); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` captured as 2025-11-10 for this entry.
- *2025-11-10:* Phase 3.2 verification: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 5]`; `pytest -q` (211 passed, 54 skipped, 39.75 s); `.venv/bin/ruff check` (All checks passed); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` re-run for the log (2025-11-10).
- *2025-11-10:* Phase 2.3 prep: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 3]`; `pytest -q` (209 passed, 54 skipped, 39.71 s); `.venv/bin/ruff check` (clean); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` captured as 2025-11-10 for the log entry.
- *2025-11-10:* Phase 2.3 verification: post-doc pass `git status -sb` still reports `## runner-refactor...origin/runner-refactor [ahead 3]`; `pytest -q` (209 passed, 54 skipped, 39.69 s); `.venv/bin/ruff check` (All checks passed); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). `date -u +%Y-%m-%d` re-run to confirm the same stamp (2025-11-10).
- *2025-11-10:* Phase 2.1 baseline: `git status -sb` reports `## runner-refactor...origin/runner-refactor [ahead 1]`; `pytest -q` (207 passed, 54 skipped, 39.84 s), `.venv/bin/ruff check` (pass), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 2.1 wizard module verification: post-extraction `git status -sb` still shows a clean feature branch; `pytest -q` (209 passed, 54 skipped, 39.77 s), `.venv/bin/ruff check` (pass after removing an unused import), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 3.1 verification: `git status -sb` → `runner-refactor...origin/runner-refactor [ahead 4]` with staged metadata/doc edits; `pytest -q` (209 passed, 54 skipped, 39.91 s); `.venv/bin/ruff check` (All checks passed!); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Captured after wiring `runner.py` + tests to the new metadata module.
- *2025-11-10:* Phase 3.1 prep: `git status -sb` → `runner-refactor...origin/runner-refactor [ahead 4]`; `pytest -q` (209 passed, 54 skipped, 39.72 s); `.venv/bin/ruff check` (All checks passed!); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Logged before extracting the metadata helpers per Phase 3.1 plan.
- *2025-11-10:* Phase 2.2 prep: `git status -sb` → `runner-refactor...origin/runner-refactor [ahead 2]`; `pytest -q` (209 passed, 54 skipped, 39.84 s); `.venv/bin/ruff check` (clean); `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org); fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Logged outputs here ahead of loader/wizard wiring updates.
- *2025-11-10:* Phase 2.2 verification: post-implementation `pytest -q` (209 passed, 54 skipped, 39.84 s), `.venv/bin/ruff check` (clean after ruff auto-fix sorted imports), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 1.2 kickoff prep: `git status -sb` shows `runner-refactor...origin/runner-refactor` with local edits in CODEX.md/README.md/agents.md/docs/DECISIONS.md; baseline checks ran `pytest -q` (204 passed, 54 skipped, 39.98s), `.venv/bin/ruff check` (clean), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), and fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings).
- *2025-11-10:* Phase 1.2 validation: post-implementation `git status -sb` lists additional edits under docs/refactor/mod_refactor.md, docs/runner_refactor_checklist.md, frame_compare.py, src/frame_compare/core.py, tests/test_paths_preflight.py, and the new tests/test_preflight.py; verification commands — `pytest -q` (207 passed, 54 skipped, 39.73 s), `.venv/bin/ruff check` (pass), `npx pyright --warnings` (failed: npm ENOTFOUND registry.npmjs.org), fallback `.venv/bin/pyright --warnings` (0 errors, 0 warnings) — all recorded here.
- *2025-11-10:* Documented the sequential-thinking context management policy: CODEX now spells out how to summarize `process_thought`/`generate_summary` output, archive older thoughts, and prefer the lightweight summary path; AGENTS Standard Flow reminds advisors to enforce the rule, and README links humans to the new section so they know why responses stay condensed.
- *2025-11-10:* Tuned the context-management defaults to keep roughly 7–10 recent Sequential Thinking entries (instead of 3–5) in active chat, clarifying that Codex may momentarily expand the window during complex branches while still using the MCP log for archives; README and AGENTS were updated accordingly.
- *2025-11-10:* Documented Sequential Thinking metadata etiquette: README now explains that `files_touched`, `tests_to_run`, `dependencies`, etc. stay empty when not used, CODEX forbids fabricated filenames/tests/risk levels, and AGENTS remind reviewers to flag hallucinated metadata.
- *2025-11-10:* Strengthened AGENTS/CODEX guardrails for MCP tooling: Standard Flow now mandates Context7-first citations and detailed Fetch MCP metadata logging (URL, timestamp, format, chunking) directly in responses, plus TaskFlow + snf-mcp recommendations for structured planning/search (no repo-level evidence storage yet per user request). CODEX now lists MCP usage in Execution & Approvals, adds an escalation playbook, clarifies `.venv`-first verification with `uv sync` fallbacks, and records how large refactors can proceed once a micro-plan + verification schedule are approved.
- *2025-11-10:* Corrected future-dated DECISIONS/CHANGELOG entries by aligning them with actual UTC (`date -u`) stamps and updated AGENTS/CODEX so every log requires capturing the current date before writing.
- *2025-11-08:* Started the configuration-audit initiative requested by the user: created `docs/config_audit.md` to track per-category findings/status, recorded the workflow expectations (Context7 reference, ripgrep sweeps, approval gates), and deferred all actual config/code updates until the user signs off category-by-category.
- *2025-11-08:* Landed the `[analysis]` configuration cleanup: removed the redundant `skip_head_seconds`/`skip_tail_seconds` knobs (loader now migrates them onto `ignore_*` with conflict checks), introduced `[analysis.thresholds]` with an explicit `mode = "quantile" | "fixed_range"` plus validated quantile/luma payloads, and updated the runner/JSON layouts so operators can see the active strategy.
- *2025-11-08:* Addressed the Phase 4 “thin shim” code review item: removed the blanket `globals().update`/`__getattr__` bridge from `frame_compare.py`, explicitly aliased the handful of helpers we still expose for backwards compatibility, and added a `typings/frame_compare/__init__.pyi` stub so Pyright flags any future wildcard re-exports. Updated the CLI/runner tests (`tests/test_frame_compare.py`, `tests/test_console_safety.py`, `tests/test_paths_preflight.py`, `tests/cli/test_doctor.py`—known as `tests/test_cli_doctor.py` before Phase 9.9) to import helpers from `src.frame_compare.core`/`cli_runtime` directly, keeping the shim focused on Click wiring.
- *2025-11-08:* Delivered the promised programmatic runner API knobs: `RunRequest` now accepts `reporter_factory`/`reporter`/`console`, `quiet=True` swaps in a `NullCliOutputManager` so automation logs remain silent, and README documents how to inject a custom reporter. Added regression tests ensuring quiet mode bypasses the CLI renderer and that custom factories are respected.

- *2025-11-09:* Phase 5 completion: confirmed TMDB orchestration already flows through `frame_compare.resolve_tmdb_workflow` (backed by `src.frame_compare.tmdb_workflow.resolve_workflow`), verified reporter injection docs/tests cover automation use, and reran quality gates on a connected host — `npx pyright --warnings`, `.venv/bin/ruff check`, and `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (258 passed in 7.21 s) to bypass the auto-loaded vsengine plugin. Recorded results here and flipped the Phase 5 checklist rows to ☑.

- *2025-11-09:* Phase 1.1 prep for the modularization refactor: captured `git status -sb`, ran `pytest -q` (204 passed, 54 skipped, 4.90 s), `.venv/bin/ruff check` (pass), and `npx pyright --warnings` (0 errors). These baseline numbers log the required Phase 0 checklist before extracting the dedicated preflight module.
- *2025-11-09:* Phase 1.1 implementation: promoted the preflight helpers to a public API (`resolve_workspace_root`, `resolve_subdir`, `collect_path_diagnostics`, `prepare_preflight`, `PreflightResult`), rewired the CLI/runner/tests/typings, and updated the refactor tracker + checklist. Verification: `pytest -q` (204 passed, 54 skipped, 4.66 s), `.venv/bin/ruff check` (pass), `npx pyright --warnings` (0 issues).
- *2025-11-09:* Hardened tonemap override validation to reject NaN/Inf inputs and enforce positive `target_nits`, expanding the CLI regression tests accordingly. Verification: `.venv/bin/ruff check` (pass), `npx pyright --warnings` (blocked offline, npm ENOTFOUND registry.npmjs.org), `uv run pyright --warnings` (blocked by sandbox permissions when opening `~/.cache/uv`), and `.venv/bin/pytest -q` (253 passed, 1 skipped).
- *2025-11-10:* Phase 4.1 alignment module finalization: `git status -sb` → `## runner-refactor...origin/runner-refactor [ahead 7]`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` (265 passed, 1 skipped, 40.11 s); `.venv/bin/ruff check` (All checks passed); `.venv/bin/pyright --warnings` (0 errors, 0 warnings). Documented the runner wiring change (now calling `alignment_runner.apply_audio_alignment`), removed the redundant `_maybe_apply_audio_alignment` alias, and logged the remaining VSPreview script-unit test follow-up.
- *2025-11-09:* Updated CODEX/AGENTS guardrails to prioritize `.venv/bin/pyright`/Ruff/Pytest, explicitly allow `.venv`/`.uv_cache`/`~/.cache/uv` access, and document the `uv sync --all-extras --dev` setup workflow so future runs don’t depend on npm/network access.
- *2025-11-09:* Added `MANIFEST.in` to prune dev-only folders (`tests/`, `docs/`, `Legacy/`, `refactor/`, `tools/`, `.github/`) from release artifacts so end users install only runtime code; `comparison_videos/` is still shipped so fixture media remains available.
- *2025-11-09:* Updated CODEX/AGENTS documentation to require assistants to provide a ready-to-copy Conventional Commit subject (e.g., `chore: …`) in every task summary so users with commit hooks can paste it directly.

- *2025-11-11:* Phase 9.11 strict-mode cleanup for the runner stack: exposed public aliases for tonemap validation, media discovery, cache metadata, and alignment helpers so `runner.py` no longer references underscore exports, tightened json/layout handling (explicit `Mapping[str, object]` casts, guarded preview folding, and ensured `select_frames`’ clip parameter is typed), and removed unused VSPreview overlay code while fixing the CLI reporter stub + `_patch_core_helper` so tests keep intercepting the confirmation flow. Verification: `.venv/bin/pyright --warnings` → `0 errors, 0 warnings, 0 informations`; `.venv/bin/ruff check` → `All checks passed!`; `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 .venv/bin/pytest -q` → `273 passed, 1 skipped in 40.03 s`.
- *2025-11-09:* Phase 2.2 CLI shim follow-up: restored `_collect_path_diagnostics` to run with `ensure_config=False` so `frame_compare --diagnose-paths` no longer creates config files, taught `_patch_load_config` in `tests/test_paths_preflight.py` to stub `src.frame_compare.preflight.load_config`, and re-ran `.venv/bin/ruff check` (pass), `npx pyright --warnings` (still blocked offline with `npm ENOTFOUND registry.npmjs.org`), and `.venv/bin/pytest -q` (250 passed, 1 skipped) to close the Phase 4.3 quality gates.

- *2025-11-02:* Phase 4.2 verification follow-up: fixed the CLI shim imports so Pyright can see `_core` helpers, reran `npx pyright --warnings` (0 errors, 9 benign pytest warnings), restored `src/frame_compare/core.py`’s `PROJECT_ROOT` to the repo root so presets/templates resolve, and re-ran `pytest tests/cli/test_doctor.py tests/cli/test_wizard.py` (paths were `tests/test_cli_*.py` at the time) to confirm wizard auto-launch + preset flows still pass before moving to Phase 4.3.
- *2025-11-07:* Phase 4.3 QA: captured `git status -sb` before sign-off, attempted `npx pyright --warnings` (fails offline with `npm ENOTFOUND registry.npmjs.org`), and ran `.venv/bin/ruff check` plus `.venv/bin/pytest` (247 passed, 1 skipped). Recorded the blocked Pyright step, refreshed the runner checklist, and documented Phase 5 follow-ups (runner reporter injection + async TMDB parity).
- *2025-11-03:* Completed the CLI harness rollout for runner-focused tests: introduced a `_CliRunnerEnv` fixture that stubs `_prepare_preflight` and seeds temporary workspaces, added shared helpers (`_patch_core_helper`, `_patch_runner_module`, `_patch_vs_core`, `_patch_audio_alignment`) so tests patch the same symbols the runner imports, migrated `tests/test_frame_compare.py` and `tests/test_paths_preflight.py` to the new fixtures, and reran `.venv/bin/pytest tests/test_frame_compare.py tests/test_paths_preflight.py` followed by the full `.venv/bin/pytest` suite (247 passed, 1 skipped). `npx pyright --warnings` still fails offline (npm ENOTFOUND); noted for follow-up once network access is available.
- *2025-11-10:* Phase 4.1 helper extraction: created `src/frame_compare/core.py`, rewired `runner.py` to import helpers directly (removing `_IMPL_ATTRS`), re-exported the helpers via `frame_compare.py`, refreshed tests, and documented the completion in `docs/runner_refactor_checklist.md`.
- *2025-11-01:* Phase 4.2 regression parity + documentation: reviewed wizard/doctor coverage, exercised the new runner-level regression tests (slow.pics auto-upload cleanup + audio-alignment reuse), recorded the verification in `docs/runner_refactor_checklist.md`, updated README/CHANGELOG, and re-ran `npx pyright --warnings` (0 issues) to lock in the helper extraction work.
- *2025-11-09:* Phase 3.2 quality gates + handoff: ran `npx pyright --warnings` (0 issues), `.venv/bin/ruff check`, and `.venv/bin/pytest` (246 passed in 2.36 s); updated `docs/runner_refactor_checklist.md` to mark the phase complete and documented the Phase 4 kickoff task (migrating `_IMPL_ATTRS` helpers) as the sole residual risk.
- *2025-11-08:* Phase 2.3 (runner refactor) documentation + quality gates: README now includes a "Programmatic Usage" section that demonstrates `frame_compare.runner.RunRequest`, `docs/runner_refactor_checklist.md` records the Phase 2 audit plus a residual-risk log, and `CHANGELOG.md` highlights the public API guidance. `.venv/bin/ruff check` and `.venv/bin/pytest` passed (246 tests in 2.42s). `npx pyright --warnings` could not run due to offline npm access, so rerunning Pyright remains a follow-up together with the remaining CLI-helper migration.
- *2025-11-09:* Phase 3.1 checklist review complete: verified workspace state (`git status -sb`), confirmed shim + behavior coverage (see `frame_compare.py:4415-4444`, `tests/test_frame_compare.py:52-138`), reran `npx pyright --warnings` (0 issues) and `.venv/bin/pytest` (246 passed in 2.42 s), and updated `docs/runner_refactor_checklist.md` to reflect the remaining architecture/dead-code gap caused by `_IMPL_ATTRS` relying on CLI helpers.
- *2025-11-08:* Restored the runner extraction after the rollback: `src/frame_compare/runner.py` now owns the full orchestration flow, `frame_compare.run_cli` is a shim that builds a `RunRequest` and delegates, and the Click stack (doctor/wizard/preset) stays in `frame_compare.py`. Tests that poked internal helpers now import them from the runner when needed, and the new module is documented as the supported programmatic surface. **Phase 2 hand-off:** Objective → publish a stable public runner API (docs + samples) and remove lingering CLI-only helpers from tests; Follow-ups → document programmatic invocation in README, add integration tests that call `runner.run` directly, explore packaging a `frame_compare.runner` console entry for automation; Risks → callers may rely on internal helpers before the API stabilises, so changes must remain backwards-compatible until the contract is formalised.
- *2025-11-07:* Split the CLI orchestration into `src/frame_compare/runner.py`, moving `RunResult` plus the full `run` logic behind a `RunRequest` struct. `frame_compare.py` now acts as a thin Click wrapper delegating to the runner while re-exporting compatibility symbols, keeping wizard/doctor wiring untouched.
- *2025-11-07:* Retuned tone-mapping presets to use the new libplacebo controls: upgraded `reference`/`filmic`/`spline`/`contrast`, added `bright_lift` and `highlight_guard`, nudged defaults (smoothing 45f, percentile `99.995`, contrast `0.30`), and propagated the changes through docs, config templates, and layout summaries.
- *2025-11-06:* Exposed libplacebo smoothing/scene thresholds, percentile, contrast recovery, metadata selection, Dolby Vision toggles, and tonemap debugging flags (`visualize_lut`, `show_clipping`). Config schema, CLI, layout, and docs were updated so operators can replicate libplacebo’s `high_quality` profile or audit tone-mapping output without editing scripts; compatibility shims still cover older plugins.
- *2025-11-06:* Added BT.2390 knee/DPD controls and the limited-range post-tonemap gamma stage. Config schema now exposes `knee_offset`, `dst_min_nits=0.18` defaults, `dpd_preset`, `dpd_black_cutoff`, and optional gamma lift toggles, alongside CLI overrides (`--tm-*`) and updated presets/docs/tests to prevent near-black crush regressions.
- *2025-11-06:* Added `[screenshots].export_range` (default `"full"`) to control final PNG range, expanding limited SDR to sRGB by default while retaining a `"limited"` escape hatch; updated screenshot writers, config templates, docs, and tests to reflect the change.
- *2025-11-05:* Sampled tonemapped RGB clips to detect actual colour range, aligning `_ColorRange` metadata with pixel values, preserving props across overlays, and documenting/testing the harmonised path to prevent washed-out PNGs.
- *2025-11-10:* Clarified Sequential Thinking guidance in CODEX/AGENTS/README so every stage (Scoping → Research & Spike → Implementation → Testing → Review) is logged, and `next_thought_needed` stays `true` until the final Review thought keeps the orchestrator loop active.
- *2025-10-31:* Enhanced the offline HTML report viewer with filmstrip thumbnails, selection-category filters, new difference/blink modes, and a fullscreen toggle. Updated styles, keyboard shortcuts, and documentation to reflect the richer theatre experience while keeping persistence compatible with previous localStorage payloads.
- *2025-10-30:* Auto-launched the wizard when `config/config.toml` is missing in interactive sessions, added `--no-wizard`/`FRAME_COMPARE_NO_WIZARD` opt-outs, reused the existing wizard prompt stack for config creation, and left non-interactive runs seeding the template with a reminder about `frame-compare wizard`.
- *2025-10-30:* Revamped the offline HTML report viewer with persistent zoom/fit presets, mouse-wheel zoom around the pointer, pan gestures, alignment presets, and shortcut guidance to align the offline experience with slow.pics.
- *2025-10-30:* Audio alignment progress now uses a Rich spinner instead of a misleading 0/1 progress bar to keep CLI feedback honest during offset estimation.
- *2025-10-22:* Default slow.pics uploads now ship disabled (`auto_upload=false`) with a CLI warning when operators opt in, documentation tables are generated from dataclass defaults, Ruff linting was added to CI (Pyright made blocking), a `frame-compare` console script was registered, and the unused `tools/readability_check.py` helper was retired.
- *2025-10-23:* Introduced the offline HTML report (configurable via `[report]` or `--html-report`) backed by `src/report.py`, vendored assets (`src/data/report/`), and CLI integration that auto-opens the generated `index.html` when requested. Added unit coverage (`tests/test_report.py`) and documented the workflow in README/config references.
- *2025-10-24:* Enhanced the HTML report viewer with a mode toggle (`slider` vs `overlay`), added keyboard/click encode cycling, embedded report data to avoid `file://` fetch issues, and expanded JS/CSS to support both viewing experiences.
- *2025-10-20:* Guaranteed VSPreview script uniqueness by adding per-run UUID suffixes and logging when a timestamped name is already present so operators keep manual edits across concurrent sessions.
- *2025-10-20:* Documented the SDR odd-geometry pivot (config guide plus dedicated geometry notes), surfaced Rich console notifications for full-chroma promotions, and clarified that dithering only occurs during the final 16→8 RGB conversion while HDR behaviour remains unchanged.
- *2025-10-20:* Audited the new `zip(..., strict=True)` guards in geometry planning/rendering: confirmed they surface invariant breaks earlier (helpful for mismatched clip/plan lists or stale colour metadata), noted the trade-off that they now raise `ValueError` instead of silently truncating when callers mis-size inputs, and captured mitigation strategies (defensive asserts in planner tests and explicit list construction) so operational runs fail fast with actionable logs rather than partial renders.
- *2025-10-18:* When screenshot rendering receives VapourSynth clips without matrix/transfer metadata we now probe frame props and default to Rec.709 limited values so `resize.Point` can emit RGB24 without raising "no path between colours"; regression tests cover the fallback and metadata-preservation paths.
- *2025-10-17:* Finalised the VSPreview-assisted manual alignment UX, documenting the new flag in README/REFERENCE, expanding the audio-alignment guide with prerequisites and fallback behaviour, surfacing the hook in CLI help, and extending automated + manual QA coverage for the headless fallback path.
- *2025-10-16:* Enforced workspace containment for analysis cache and audio offset files via `_resolve_workspace_subdir`, added regression coverage for escape attempts, removed the generated `config.toml` (template remains the source of defaults), and limited automatic screenshot cleanup to directories created during the active run.
- *2025-10-16:* Constrained supported Python versions to 3.13.x (`>=3.13,<3.14`) because `librosa`/`numba` fail to build on 3.14; updated pyproject/lock files accordingly.
- *2025-10-14:* Locked workspace root discovery to `--root`/`FRAME_COMPARE_ROOT`/sentinel hierarchy, seeded config under `ROOT/config/config.toml`, enforced `ROOT/comparison_videos[/screens]` outputs, and added diagnostics + site-packages guardrails.
- *2025-10-12:* Default config seeding now targets `~/.frame-compare/config.toml`, the packaged template lives under `src/data/` with explicit package data so wheels retain it, and `[paths].input_dir` defaults to `~/comparison_videos` to avoid site-packages permission traps. *(superseded by 2025-10-14 workspace root lock.)*
- *2025-10-11:* `copy_default_config` now honours `$FRAME_COMPARE_TEMPLATE_PATH` and falls back to the repository template when the packaged `data` module is unavailable, letting us drop the setuptools package-dir mapping without breaking config seeding.
- *2025-10-11:* Screenshot generation wraps directory creation failures in `ScreenshotError` so permission-denied errors surface with actionable guidance about choosing a writable `[paths].input_dir`.
- *2025-10-09:* When the packaged install directory is read-only we now seed the default config under `~/.frame-compare/config.toml`, logging the relocation so users know to point overrides there instead of the site-packages path. *(legacy approach before 2025-10-14 root lock.)*
- *2025-10-10:* Restored the ability to disable FFmpeg screenshot timeouts by permitting `screenshots.ffmpeg_timeout_seconds = 0` and treating non-positive values as "no timeout" when invoking FFmpeg.
- *2025-10-18:* Added `screenshots.ffmpeg_timeout_seconds` plus `-nostdin` when spawning FFmpeg to stop runaway renders from freezing Windows shells; surfaced the timeout in CLI render metadata and config docs.
- *2025-10-17:* CLI layout tweaks: dropped the banner headline, repurposed the Analyze slot to show cached-metric reuse, removed the At-a-Glance crop-mod snippet in favour of resolved tonemap nits, and slimmed the Summary output block to avoid redundant frame counts.
- *2025-10-16:* Deep review flagged that `screenshots.directory_name` must be constrained to stay under the resolved input root before cleanup; follow-up will enforce containment checks before writing or deleting screenshot outputs (see `docs/deep_review.md`).
- *2025-10-15:* Relocated bundled comparison fixtures from `tests/fixtures/media/comparison_videos` to the repository-root
  `comparison_videos/` directory so CLI defaults, config templates, and contributor docs reference the same location as the
  fallback resolution added to `run_cli`.
- *2025-10-14:* Adjusted CLI theming to separate hierarchy (muted section badges, yellow subheads) and rewrote the At-a-Glance summary to surface sampling, window, and alignment metrics requested in the usability review.
- *2025-10-13:* Dropped the unused `types-pytest` dependency from the dev group because the package is unavailable on PyPI and broke `uv run` environment creation on fresh clones. CI keeps installing real `pytest` through the dev group, so workflows and local test runs continue to function normally.
- *2025-10-12:* Introduced local stubs for click, requests, httpx, and rich plus tighter JSON-tail helpers in tests to eliminate Pyright/Pylance import and indexing errors while keeping diagnostics strict.
- *2025-10-11:* Audited the `docs/` catalog, refreshed the deep-review memo with current safeguards/follow-ups, and corrected README reference defaults to match the live config schema.
- *2025-10-10:* Hardened CLI progress configuration by validating styles during config load, normalizing the stored value, and simplifying runtime flag handling to avoid getattr/except patterns flagged by linters.
- *2025-10-09:* Adjusted overlay text defaults so minimal mode now shows resolution/upscale context and frame-selection type while diagnostic mode drops per-frame selection detail lines that were redundant on-screen but remain available in cached metadata.
- *2025-10-02:* Restricted audio alignment's NumPy warning suppression to local contexts, paired with regression coverage that preserves global diagnostics while muting noisy dependencies.
- *2025-10-02:* Bounded the TMDB response cache to a configurable entry limit with TTL-aware eviction to stop unbounded growth flagged in deep-review performance findings.
- *2025-10-01:* Documented the audio alignment pipeline in `docs/audio_alignment_pipeline.md` to centralize requirements, workflow, and offsets file semantics for ongoing feature work.
- *2025-10-01:* Persisted selection metadata sidecar v1 with deterministic cache keys, JSON-tail exposure, and generated.compframes annotations to satisfy the CLI selection cache persistence guide.
- *2025-09-30:* Standardised group subhead styling across CLI sections: accent-subhead prefixes (`›`/`>` fallback), dim divider rules sized to block content, column alignment for numeric values, and verbose legends describing token roles to satisfy `features/CLI/GUIDE.md`.
- *2025-09-30:* Simplified diagnostic overlays by replacing the HDR MAX/AVG measurement block with render resolution, mastering display luminance (for HDR sources), and cached frame-selection metadata while trimming redundant frame-info lines to keep CLI banners uncluttered.
- *2025-09-19:* Adopted CLI layout styling DSL with semantic spans and data-driven highlight rules. Renderer now consumes palette roles (`value`, `unit`, `path`, etc.), honors section accent theming, and evaluates JSON-configured thresholds (e.g., tonemap verification, boolean states) to keep formatting declarative.
- *2025-10-14:* Adopted key/value styling in the CLI Summary list to mirror At-a-Glance key/value formatting and keep closing metrics aligned.
- *2025-11-10:* Restored runner's audio-alignment hook to `core._maybe_apply_audio_alignment` so tests and downstream callers can continue stubbing the helper, then deep-copied the JSON tail's audio block before deriving the CLI layout view to keep manual trims/offsets isolated from UI mutations. (Superseded later the same day by the “Phase 4.1 alignment module finalization” entry once planner/runner tests were updated to stub the new module boundary.) Reference: Python 3.11 FAQ on `dict.copy()` shallow semantics (source:https://github.com/python/cpython/blob/v3.11.14/Doc/faq/programming.rst @2025-11-10).
- *2025-11-10:* Locked pytest configuration to skip the third-party `vsengine` plugin (which otherwise instantiates an abstract `VapoursynthEnvironment` during collection) by adding `addopts = "-p no:vsengine"` under `[tool.pytest.ini_options]` in `pyproject.toml`. This makes plain `pytest`/VS Code discovery behave the same as our documented `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 …` command and unblocks commit hooks that run `pytest` without environment overrides.
- *2025-11-12:* CI maintenance — updated `.github/workflows/ci.yml` so the Linux test job installs the `preview` extra (ensuring VSPreview/PySide6 exist for `tests/runner/test_audio_alignment_cli.py::test_launch_vspreview_generates_script`) and switched the lint job’s import-linter install step to `uv pip install import-linter` to avoid the missing `pip` module inside `.venv`. No local tests rerun (workflow-only change).
